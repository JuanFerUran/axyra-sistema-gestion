<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Dashboard</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Scripts removidos por limpieza del sistema -->

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Configuración de Firebase AXYRA -->
    <script src="../../static/firebase-config.js"></script>

    <!-- SISTEMA AISLADO -->
    <!-- <script src="../../static/isolated-auth.js"></script> -->
    <!-- <script src="../../static/debug-auth.js"></script> -->
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Dashboard</div>
          </div>
        </div>

        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link" onclick="irAInicio(event)">
            <i class="fas fa-home"></i> Inicio
          </a>
          <a href="dashboard.html" class="axyra-nav-link active"> <i class="fas fa-tachometer-alt"></i> Dashboard </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> Nómina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuración
          </a>
          <!-- Botón de inicio removido para evitar duplicación -->
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Dashboard</h1>
          <p class="axyra-page-subtitle">Resumen general de tu empresa y estadísticas importantes</p>
        </div>

        <!-- Mensaje de Bienvenida -->
        <div class="axyra-welcome-card" id="welcomeCard">
          <div class="axyra-welcome-icon">
            <i class="fas fa-sun"></i>
          </div>
          <div class="axyra-welcome-content">
            <h2 class="axyra-welcome-title" id="welcomeTitle">¡Bienvenido a AXYRA!</h2>
            <p class="axyra-welcome-message" id="welcomeMessage">
              Esperamos que tengas un excelente día gestionando tu empresa
            </p>
            <div class="axyra-welcome-time" id="welcomeTime"></div>
            <div class="axyra-company-info" id="companyInfo">
              <div class="axyra-company-name" id="companyName"></div>
              <div class="axyra-company-nit" id="companyNIT"></div>
            </div>
          </div>
        </div>

        <!-- Estadísticas Principales -->
        <div class="axyra-stats-grid">
          <div class="axyra-stat-card clickable" onclick="mostrarDetalleEmpleados()">
            <div class="axyra-stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="axyra-stat-number" id="totalEmpleados">0</div>
            <div class="axyra-stat-label">Total Empleados</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleHoras()">
            <div class="axyra-stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="axyra-stat-number" id="horasTrabajadas">0</div>
            <div class="axyra-stat-label">Horas Trabajadas</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleComprobantes()">
            <div class="axyra-stat-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="axyra-stat-number" id="comprobantesGenerados">0</div>
            <div class="axyra-stat-label">Comprobantes</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleSalarios()">
            <div class="axyra-stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="axyra-stat-number" id="totalSalarios">$0</div>
            <div class="axyra-stat-label">Total Salarios</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>
        </div>

        <!-- Estadísticas Secundarias -->
        <div class="axyra-stats-grid-secondary">
          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="empleadosActivos">0</div>
              <div class="axyra-stat-label-secondary">Empleados Activos</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="horasMes">0</div>
              <div class="axyra-stat-label-secondary">Horas del Mes</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="nominasGeneradas">0</div>
              <div class="axyra-stat-label-secondary">Nóminas Generadas</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-calculator"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="cuadresCaja">0</div>
              <div class="axyra-stat-label-secondary">Cuadres de Caja</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="departamentos">0</div>
              <div class="axyra-stat-label-secondary">Departamentos</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="tareasPendientes">0</div>
              <div class="axyra-stat-label-secondary">Tareas Pendientes</div>
            </div>
          </div>
        </div>

        <!-- Indicadores de Productividad -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Indicadores de Productividad</h3>
              <p class="axyra-card-subtitle">Métricas de eficiencia y rendimiento</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div id="productivityIndicators">
              <!-- Los indicadores se cargan dinámicamente -->
            </div>
          </div>
        </div>

        <!-- Gráficos y Análisis -->
        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribución de Empleados</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="employeeDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Tendencia de Horas</h3>
                <p class="axyra-card-subtitle">Por mes</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="hoursTrendChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-bar"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribución de Salarios</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="salaryDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-area"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Métricas de Productividad</h3>
                <p class="axyra-card-subtitle">Eficiencia y ocupación</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="productivityChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <!-- Configuración Regional -->
        <div class="axyra-grid axyra-grid-2"></div>

        <!-- Panel de Configuración -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-cog"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Configuración de Cuenta</h3>
              <p class="axyra-card-subtitle">Gestiona tu perfil y configuraciones de seguridad</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-config-grid">
              <!-- Perfil de Usuario -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-user"></i> Perfil de Usuario</h4>
                <div class="axyra-config-item">
                  <label>Nombre de Usuario:</label>
                  <input type="text" id="configUsername" class="axyra-config-input" />
                  <button class="axyra-config-btn" onclick="actualizarUsername()">
                    <i class="fas fa-save"></i> Actualizar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Email:</label>
                  <input type="email" id="configEmail" class="axyra-config-input" readonly />
                  <span class="axyra-config-status" id="emailStatus">No verificado</span>
                </div>
              </div>

              <!-- Seguridad -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-shield-alt"></i> Seguridad</h4>
                <div class="axyra-config-item">
                  <label>Cambiar Contraseña:</label>
                  <button class="axyra-config-btn" onclick="mostrarModalCambiarPassword()">
                    <i class="fas fa-key"></i> Cambiar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Autenticación 2FA:</label>
                  <div class="axyra-2fa-controls">
                    <button class="axyra-config-btn" id="btn2FA" onclick="toggle2FA()">
                      <i class="fas fa-toggle-off"></i> Deshabilitado
                    </button>
                    <button
                      class="axyra-config-btn"
                      onclick="configurarGoogleAuthenticator()"
                      style="display: none"
                      id="btnGoogleAuth"
                    >
                      <i class="fab fa-google"></i> Google Auth
                    </button>
                  </div>
                  <small class="axyra-help-text">El 2FA solo se pedirá si lo tienes habilitado</small>
                </div>
                <div class="axyra-config-item">
                  <label>Verificación de Email:</label>
                  <button class="axyra-config-btn" onclick="enviarVerificacionEmail()" id="btnVerificarEmail">
                    <i class="fas fa-envelope"></i> Verificar
                  </button>
                </div>
              </div>

              <!-- Preferencias -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-sliders-h"></i> Preferencias</h4>
                <div class="axyra-config-item">
                  <label>Recordar Sesión:</label>
                  <select id="configRememberSession" class="axyra-config-select" onchange="actualizarPreferencias()">
                    <option value="0">Siempre pedir login</option>
                    <option value="1">1 día</option>
                    <option value="7">1 semana</option>
                    <option value="30">1 mes</option>
                  </select>
                </div>
                <div class="axyra-config-item">
                  <label>Notificaciones:</label>
                  <label class="axyra-checkbox">
                    <input type="checkbox" id="configNotificaciones" onchange="actualizarPreferencias()" />
                    <span class="checkmark"></span>
                    Recibir notificaciones por email
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Actividad Reciente</h3>
              <p class="axyra-card-subtitle">Últimas acciones en el sistema</p>
            </div>
          </div>
          <div id="actividadReciente">
            <!-- La actividad se cargará dinámicamente -->
          </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Acciones Rápidas</h3>
              <p class="axyra-card-subtitle">Accede rápidamente a las funciones principales</p>
            </div>
          </div>
          <div class="axyra-actions-bar">
            <button
              onclick="mostrarModalAccion('Agregar Empleado', '¿Deseas ir a la página de empleados para agregar un nuevo empleado?', 'empleados')"
              class="axyra-btn axyra-btn-primary"
            >
              <i class="fas fa-user-plus"></i> Agregar Empleado
            </button>
            <button
              onclick="mostrarModalAccion('Registrar Horas', '¿Deseas ir a la página de horas para registrar el tiempo trabajado?', 'horas')"
              class="axyra-btn axyra-btn-secondary"
            >
              <i class="fas fa-clock"></i> Registrar Horas
            </button>
            <button
              onclick="mostrarModalAccion('Generar Nómina', '¿Deseas ir a la página de nómina para generar el reporte de salarios?', 'nomina')"
              class="axyra-btn axyra-btn-success"
            >
              <i class="fas fa-file-invoice-dollar"></i> Generar Nómina
            </button>
            <button
              onclick="mostrarModalAccion('Cuadre de Caja', '¿Deseas ir a la página de cuadre de caja para revisar los ingresos?', 'cuadre')"
              class="axyra-btn axyra-btn-info"
            >
              <i class="fas fa-calculator"></i> Cuadre de Caja
            </button>
            <button
              onclick="mostrarModalConfirmacion('Limpiar Datos', '¿Estás seguro de que deseas limpiar todos los datos corruptos del sistema? Esta acción no se puede deshacer.', 'limpiarDatosCorruptos')"
              class="axyra-btn axyra-btn-warning"
            >
              <i class="fas fa-broom"></i> Limpiar Datos
            </button>
            <button
              onclick="mostrarModalConfirmacion('Resetear Todo', '⚠️ ADVERTENCIA: ¿Estás completamente seguro de que deseas eliminar TODOS los datos del sistema? Esta acción es IRREVERSIBLE y eliminará toda la información.', 'resetearLocalStorage')"
              class="axyra-btn axyra-btn-error"
            >
              <i class="fas fa-trash"></i> Resetear Todo
            </button>
            <button onclick="refrescarDashboard()" class="axyra-btn axyra-btn-ghost">
              <i class="fas fa-sync-alt"></i> Actualizar
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Cambiar Contraseña -->
    <div id="modalCambiarPassword" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fas fa-key"></i> Cambiar Contraseña</h3>
          <button class="axyra-modal-close" onclick="cerrarModalCambiarPassword()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <form id="formCambiarPassword">
            <div class="axyra-form-group">
              <label for="currentPassword">Contraseña Actual:</label>
              <div class="password-container">
                <input type="password" id="currentPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleCurrentPassword()">
                  <i class="fas fa-eye" id="currentPasswordIcon"></i>
                </button>
              </div>
            </div>
            <div class="axyra-form-group">
              <label for="newPassword">Nueva Contraseña:</label>
              <div class="password-container">
                <input type="password" id="newPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleNewPassword()">
                  <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
              </div>
              <small class="axyra-form-help">Mínimo 8 caracteres, incluir mayúsculas y números</small>
            </div>
            <div class="axyra-form-group">
              <label for="confirmNewPassword">Confirmar Nueva Contraseña:</label>
              <div class="password-container">
                <input type="password" id="confirmNewPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleConfirmNewPassword()">
                  <i class="fas fa-eye" id="confirmNewPasswordIcon"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCambiarPassword()">Cancelar</button>
          <button class="axyra-btn axyra-btn-primary" onclick="cambiarPassword()">Cambiar Contraseña</button>
        </div>
      </div>
    </div>

    <!-- Modal Configurar Google Authenticator -->
    <div id="modalGoogleAuth" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fab fa-google"></i> Configurar Google Authenticator</h3>
          <button class="axyra-modal-close" onclick="cerrarModalGoogleAuth()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-google-auth-setup">
            <div class="axyra-qr-section">
              <h4>1. Escanea el código QR</h4>
              <div id="qrCode" class="axyra-qr-container">
                <!-- El código QR se generará aquí -->
              </div>
              <p>Usa la aplicación Google Authenticator para escanear este código</p>
            </div>
            <div class="axyra-manual-section">
              <h4>2. O ingresa manualmente</h4>
              <div class="axyra-form-group">
                <label>Clave Secreta:</label>
                <input type="text" id="secretKey" class="axyra-form-input" readonly />
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="copiarClaveSecreta()">
                  <i class="fas fa-copy"></i> Copiar
                </button>
              </div>
              <p>Ingresa esta clave en tu aplicación de autenticación</p>
            </div>
            <div class="axyra-verification-section">
              <h4>3. Verifica la configuración</h4>
              <div class="axyra-form-group">
                <label>Código de Verificación:</label>
                <input
                  type="text"
                  id="verificationCode"
                  class="axyra-form-input"
                  placeholder="Ingresa el código de 6 dígitos"
                  maxlength="6"
                />
              </div>
              <button class="axyra-btn axyra-btn-primary" onclick="verificarGoogleAuth()">
                <i class="fas fa-check"></i> Verificar y Activar
              </button>
            </div>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalGoogleAuth()">Cancelar</button>
        </div>
      </div>
    </div>

    <script>
      // Verificar autenticación - FIREBASE + SISTEMA AISLADO MEJORADO
      async function checkAuth() {
        try {
          console.log('🔐 Verificando autenticación...');

          // PRIMERO: Verificar Firebase
          if (typeof firebase !== 'undefined' && firebase.auth) {
            const firebaseUser = firebase.auth().currentUser;
            if (firebaseUser) {
              console.log('🔥 Usuario autenticado con Firebase:', firebaseUser.email);
              currentUser = {
                id: firebaseUser.uid,
                username: firebaseUser.email.split('@')[0],
                email: firebaseUser.email,
                nombre: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                rol: 'usuario',
                createdAt: new Date().toISOString(),
              };

              // Guardar en localStorage para compatibilidad
              localStorage.setItem('axyra_firebase_user', JSON.stringify(firebaseUser));
              localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));

              console.log('✅ Usuario autenticado, cargando dashboard...');
              return true;
            }
          }

          // SEGUNDO: Verificar localStorage (Firebase user)
          const firebaseUser = localStorage.getItem('axyra_firebase_user');
          if (firebaseUser) {
            try {
              const userData = JSON.parse(firebaseUser);
              console.log('✅ Usuario Firebase encontrado en localStorage:', userData.email);

              // Verificar si es un usuario de Google
              if (userData.provider === 'google') {
                // Intentar obtener datos completos del usuario desde localStorage
                const isolatedUser = localStorage.getItem('axyra_isolated_user');
                if (isolatedUser) {
                  try {
                    const isolatedData = JSON.parse(isolatedUser);
                    if (isolatedData.uid === userData.uid) {
                      currentUser = isolatedData;
                      console.log('✅ Usuario de Google autenticado:', currentUser);
                      return true;
                    }
                  } catch (error) {
                    console.warn('⚠️ Error parseando datos aislados:', error);
                  }
                }
              }

              // Fallback a datos básicos
              currentUser = {
                id: userData.uid,
                username: userData.email.split('@')[0],
                email: userData.email,
                nombre: userData.displayName || userData.email.split('@')[0],
                rol: 'usuario',
                createdAt: new Date().toISOString(),
              };

              console.log('✅ Usuario autenticado, cargando dashboard...');
              return true;
            } catch (error) {
              console.error('❌ Error parseando usuario Firebase:', error);
              localStorage.removeItem('axyra_firebase_user');
            }
          }

          // TERCERO: Verificar localStorage (sistema aislado)
          const isolatedUser = localStorage.getItem('axyra_isolated_user');
          if (isolatedUser) {
            try {
              const userData = JSON.parse(isolatedUser);
              console.log('✅ Sesión encontrada en localStorage:', userData.username);
              currentUser = userData;

              // Restaurar el estado del sistema aislado si está disponible
              if (window.axyraIsolatedAuth) {
                window.axyraIsolatedAuth.currentUser = userData;
                window.axyraIsolatedAuth.isAuthenticated = true;
                console.log('✅ Estado del sistema aislado restaurado');
              }

              console.log('✅ Usuario autenticado, cargando dashboard...');
              return true;
            } catch (error) {
              console.error('❌ Error parseando sesión aislada:', error);
              localStorage.removeItem('axyra_isolated_user');
            }
          }

          // CUARTO: Verificar sistema aislado
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            const user = window.axyraIsolatedAuth.getCurrentUser();
            console.log('✅ Usuario autenticado con sistema aislado:', user.username);
            currentUser = user;
            console.log('✅ Usuario autenticado, cargando dashboard...');
            return true;
          }

          // No hay sesión activa
          console.log('⚠️ No hay sesión activa - mostrando mensaje de login');
          mostrarMensajeNoAutenticado();
          return false;
        } catch (error) {
          console.error('❌ Error al verificar sesión:', error);
          mostrarMensajeNoAutenticado();
          return false;
        }
      }

      // Función para mostrar mensaje cuando no hay autenticación
      function mostrarMensajeNoAutenticado() {
        const mainContent = document.querySelector('.axyra-section');
        if (mainContent) {
          mainContent.innerHTML = `
            <div class="axyra-container">
              <div class="axyra-page-header">
                <h1 class="axyra-page-title">🔐 Acceso Requerido</h1>
                <p class="axyra-page-subtitle">Necesitas iniciar sesión para acceder al dashboard</p>
              </div>
              
              <div class="axyra-auth-required-card">
                <div class="axyra-auth-required-icon">
                  <i class="fas fa-lock"></i>
                </div>
                <h2>Inicia Sesión para Continuar</h2>
                <p>Para acceder al dashboard y todas las funcionalidades de AXYRA, necesitas iniciar sesión con tu cuenta.</p>
                
                <div class="axyra-auth-actions">
                  <button class="axyra-btn axyra-btn-primary" onclick="irALogin()">
                    🔐 Iniciar Sesión
                  </button>
                  <button class="axyra-btn axyra-btn-secondary" onclick="irARegistro()">
                    📝 Crear Cuenta
                  </button>
                  <button class="axyra-btn axyra-btn-ghost" onclick="irAInicio()">
                    🏠 Volver al Inicio
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      // Función para ir al login
      function irALogin() {
        window.location.href = '../../login.html';
      }

      // Función para ir al registro
      function irARegistro() {
        window.location.href = '../../register.html';
      }

      // Función para ir al inicio
      function irAInicio() {
        window.location.href = '../../index.html';
      }

      // Cerrar sesión
      // Cerrar sesión - SISTEMA COMPLETO
      async function logout() {
        console.log('🔄 Cerrando sesión desde dashboard...');

        try {
          // PRIMERO: Cerrar sesión de Firebase
          if (typeof firebase !== 'undefined' && firebase.auth) {
            try {
              await firebase.auth().signOut();
              console.log('✅ Sesión de Firebase cerrada');
            } catch (firebaseError) {
              console.log('⚠️ Error cerrando Firebase:', firebaseError.message);
            }
          }

          // SEGUNDO: Cerrar sesión del sistema aislado
          if (window.axyraIsolatedAuth) {
            window.axyraIsolatedAuth.logout();
            console.log('✅ Sesión del sistema aislado cerrada');
          }

          // TERCERO: Limpiar localStorage completamente
          localStorage.removeItem('axyra_firebase_user');
          localStorage.removeItem('axyra_isolated_user');
          localStorage.removeItem('axyra_isolated_remember');
          console.log('✅ localStorage limpiado');

          // CUARTO: Limpiar variables globales
          currentUser = null;
          console.log('✅ Variables globales limpiadas');

          console.log('✅ Sesión completamente cerrada');

          // Redirigir al login
          window.location.href = '../../login.html';
        } catch (error) {
          console.error('❌ Error en logout:', error);
          // Aún así, limpiar y redirigir
          localStorage.removeItem('axyra_firebase_user');
          localStorage.removeItem('axyra_isolated_user');
          localStorage.removeItem('axyra_isolated_remember');
          currentUser = null;
          window.location.href = '../../login.html';
        }
      }

      // Función para limpiar datos corruptos del localStorage
      function limpiarDatosCorruptos() {
        console.log('=== LIMPIANDO DATOS CORRUPTOS ===');

        // Mostrar todos los datos del localStorage para depuración
        console.log('=== DATOS COMPLETOS DEL LOCALSTORAGE ===');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_')) {
            console.log(`${key}:`, localStorage.getItem(key));
          }
        }

        // Obtener usuario actual para aislamiento de datos
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para limpieza de datos');
          return;
        }

        // Limpiar empleados con salarios inválidos FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) =>
            emp.userId === currentUser.username || emp.userId === currentUser.email || emp.userId === currentUser.id
        );
        console.log('Empleados del usuario antes de limpieza:', empleados);

        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario válido:', empleado);
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0) {
            console.log('Empleado con salario inválido:', empleado);
            return false;
          }
          return true;
        });

        // Guardar empleados limpios
        localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
        console.log('Empleados después de limpieza:', empleadosLimpios);

        // Limpiar también datos de Firebase si está disponible
        if (typeof firebase !== 'undefined' && firebase.firestore) {
          limpiarDatosFirebase(currentUser);
        }

        // Recargar estadísticas
        cargarEstadisticas();
        cargarActividadRecienteContinuacion();

        // Mostrar mensaje de confirmación usando modal
        mostrarMensaje(
          '✅ Datos corruptos limpiados correctamente. Se han eliminado empleados con salarios inválidos.',
          'success'
        );
      }

      // Función para resetear completamente el localStorage (último recurso)
      function resetearLocalStorage() {
        console.log('=== RESETEANDO LOCALSTORAGE ===');

        // Obtener usuario actual para aislamiento de datos
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para reset de datos');
          return;
        }

        // Eliminar TODOS los datos de AXYRA (incluyendo datos del usuario actual)
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_')) {
            keysToRemove.push(key);
          }
        }

        keysToRemove.forEach((key) => {
          localStorage.removeItem(key);
          console.log(`Eliminado: ${key}`);
        });

        // Limpiar también datos de Firebase si está disponible
        if (typeof firebase !== 'undefined' && firebase.firestore) {
          limpiarDatosFirebase(currentUser);
        }

        console.log('LocalStorage reseteado completamente');
        console.log('✅ Usuario mantiene su sesión:', currentUser.username);

        // Mostrar mensaje de éxito
        mostrarMensaje(
          '✅ Todos los datos han sido reseteados correctamente. Tu sesión se mantiene activa.',
          'success'
        );

        // Recargar las estadísticas sin recargar la página
        setTimeout(() => {
          cargarEstadisticas();
          cargarActividadRecienteContinuacion();
        }, 1000);
      }

      // Función para limpiar datos de Firebase
      async function limpiarDatosFirebase(currentUser) {
        try {
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.log('ℹ️ Firebase no disponible para limpieza');
            return;
          }

          const userId = currentUser.id || currentUser.username || currentUser.email;
          if (!userId) {
            console.log('⚠️ No se puede identificar usuario para limpieza de Firebase');
            return;
          }

          console.log('🗑️ Limpiando datos de Firebase para usuario:', userId);

          // Limpiar colecciones del usuario
          const collections = ['empleados', 'horas', 'comprobantes', 'facturas', 'configuracion', 'company_config'];

          for (const collectionName of collections) {
            try {
              const querySnapshot = await firebase
                .firestore()
                .collection(collectionName)
                .where('userId', '==', userId)
                .get();

              const batch = firebase.firestore().batch();
              querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
              });

              if (querySnapshot.size > 0) {
                await batch.commit();
                console.log(`✅ Eliminados ${querySnapshot.size} documentos de ${collectionName}`);
              }
            } catch (error) {
              console.warn(`⚠️ Error limpiando colección ${collectionName}:`, error);
            }
          }

          console.log('✅ Datos de Firebase limpiados correctamente');
        } catch (error) {
          console.error('❌ Error limpiando datos de Firebase:', error);
        }
      }

      // Función para refrescar dashboard manualmente
      function refrescarDashboard() {
        try {
          console.log('🔄 Refrescando dashboard manualmente...');
          cargarEstadisticas();
          cargarActividadRecienteContinuacion();
          mostrarMensaje('✅ Dashboard actualizado', 'success');
        } catch (error) {
          console.error('❌ Error refrescando dashboard:', error);
          mostrarMensaje('❌ Error al actualizar dashboard', 'error');
        }
      }

      // Función para verificar automáticamente datos corruptos
      function verificarDatosCorruptos() {
        console.log('=== VERIFICANDO DATOS CORRUPTOS AUTOMÁTICAMENTE ===');

        let datosCorruptos = false;

        // Obtener usuario actual para aislamiento de datos
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para verificación de datos');
          return;
        }

        // Verificar empleados FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) =>
            emp.userId === currentUser.username || emp.userId === currentUser.email || emp.userId === currentUser.id
        );
        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario válido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0 || salario > 1000000000) {
            // Límite razonable de 1 billón
            console.log('Empleado con salario inválido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          return true;
        });

        // Si se encontraron datos corruptos, limpiarlos automáticamente
        if (datosCorruptos) {
          console.log('Datos corruptos detectados. Limpiando automáticamente...');
          localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
          console.log('Empleados después de limpieza automática:', empleadosLimpios);
        }

        // Verificar otros datos FILTRADOS POR USUARIO
        const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
          (hr) => hr.userId === currentUser.username || hr.userId === currentUser.email || hr.userId === currentUser.id
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) =>
            comp.userId === currentUser.username || comp.userId === currentUser.email || emp.userId === currentUser.id
        );

        // Verificar que no haya valores extremadamente altos
        const totalSalarios = empleadosLimpios.reduce((total, empleado) => {
          const salario = parseFloat(empleado.salario) || 0;
          return total + salario;
        }, 0);

        if (totalSalarios > 1000000000) {
          // Más de 1 billón
          console.log('Total de salarios extremadamente alto detectado:', totalSalarios);
          console.log('Limpiando todos los datos de empleados...');
          localStorage.removeItem('axyra_empleados');
          localStorage.removeItem('axyra_horas');
          localStorage.removeItem('axyra_comprobantes');
          datosCorruptos = true;
        }

        if (datosCorruptos) {
          console.log('✅ Datos corruptos corregidos automáticamente');
        } else {
          console.log('✅ No se encontraron datos corruptos');
        }
      }

      // Función para actualizar indicador de seguridad
      function updateSecurityStatus() {
        const securityStatus = document.getElementById('securityStatus');
        if (!securityStatus) return;

        try {
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            const user = window.axyraIsolatedAuth.getCurrentUser();
            if (user) {
              securityStatus.className = 'axyra-security-indicator';
              securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesión Activa</span>';
            } else {
              securityStatus.className = 'axyra-security-indicator warning';
              securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Sesión Expirada</span>';
            }
          } else {
            // Verificar localStorage como fallback
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              try {
                const user = JSON.parse(userData);
                if (user && user.username) {
                  securityStatus.className = 'axyra-security-indicator';
                  securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesión Activa</span>';
                  return;
                }
              } catch (error) {
                console.error('Error parseando sesión:', error);
              }
            }

            securityStatus.className = 'axyra-security-indicator danger';
            securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Sin Seguridad</span>';
          }
        } catch (error) {
          console.error('Error actualizando estado de seguridad:', error);
          securityStatus.className = 'axyra-security-indicator danger';
          securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Error</span>';
        }
      }

      // Cargar estadísticas
      async function cargarEstadisticas() {
        try {
          console.log('📊 Cargando estadísticas...');

          // Obtener usuario actual para aislamiento de datos
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('✅ Usuario Firebase:', currentUser.email);
          } else if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
            console.log('✅ Usuario sistema profesional:', currentUser.username);
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.error('❌ No hay usuario autenticado');
            return;
          }

          // Intentar cargar datos desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            console.log('🔥 Cargando datos desde Firebase...');

            try {
              // Cargar empleados desde Firebase
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              let empleados = [];
              if (!empleadosSnapshot.empty) {
                empleadosSnapshot.forEach((doc) => {
                  empleados.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
              }
              // Cargar horas desde Firebase
              const horasSnapshot = await firebase
                .firestore()
                .collection('horas')
                .where('userId', '==', currentUser.id)
                .get();

              let horas = [];
              if (!horasSnapshot.empty) {
                horasSnapshot.forEach((doc) => {
                  horas.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
              }

              const totalHorasTrabajadas = horas.reduce((total, registro) => {
                const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
                const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
                const horasExtras = parseFloat(registro.horasExtras) || 0;
                const horasDominicales = parseFloat(registro.horasDominicales) || 0;
                return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
              }, 0);

              // Solo mostrar empleados si hay horas trabajadas
              if (totalHorasTrabajadas > 0) {
                document.getElementById('totalEmpleados').textContent = empleados.length;
              } else {
                document.getElementById('totalEmpleados').textContent = '0';
              }

              // Cargar comprobantes desde Firebase
              const comprobantesSnapshot = await firebase
                .firestore()
                .collection('comprobantes')
                .where('userId', '==', currentUser.id)
                .get();

              let comprobantes = [];
              if (!comprobantesSnapshot.empty) {
                comprobantesSnapshot.forEach((doc) => {
                  comprobantes.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
              }
              document.getElementById('comprobantesGenerados').textContent = comprobantes.length;

              // Calcular total de salarios base SOLO si hay horas trabajadas
              let totalSalarios = 0;
              if (totalHorasTrabajadas > 0) {
                totalSalarios = empleados.reduce((total, empleado) => {
                  if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
                    return total;
                  }
                  const salario = parseFloat(empleado.salario);
                  if (!isNaN(salario) && salario > 0) {
                    return total + salario;
                  }
                  return total;
                }, 0);
              }

              // Formatear y mostrar datos
              formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas);

              console.log('✅ Datos cargados desde Firebase');
              return;
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando desde Firebase, usando localStorage:', firebaseError);
            }
          }

          // Fallback a localStorage
          console.log('💾 Cargando datos desde Firebase...');
          await cargarEstadisticasLocalStorage(currentUser);
        } catch (error) {
          console.error('❌ Error cargando estadísticas:', error);
          // NO redirigir al login por errores de estadísticas
          // Solo mostrar mensaje de error
          console.log('⚠️ Continuando sin estadísticas...');
        }
      }

      // Función auxiliar para cargar desde localStorage - SISTEMA AISLADO
      async function cargarEstadisticasLocalStorage(currentUser) {
        try {
          console.log('💾 Cargando estadísticas desde localStorage para usuario:', currentUser.username);

          // Empleados FILTRADOS POR USUARIO - SOLO DESDE FIREBASE
          let empleados = [];

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
            try {
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              if (!empleadosSnapshot.empty) {
                empleadosSnapshot.forEach((doc) => {
                  empleados.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`✅ Empleados cargados desde Firebase: ${empleados.length}`);
              } else {
                console.log('ℹ️ No hay empleados en Firebase para este usuario');
              }
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando desde Firebase, usando localStorage como fallback:', firebaseError);
              // Solo usar localStorage como fallback si Firebase falla
              const empleadosLocal = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
              empleados = empleadosLocal.filter(
                (emp) =>
                  emp.userId === currentUser.username ||
                  emp.userId === currentUser.email ||
                  emp.userId === currentUser.id
              );
            }
          } else {
            console.log('ℹ️ Firebase no disponible, usando localStorage');
            const empleadosLocal = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            empleados = empleadosLocal.filter(
              (emp) =>
                emp.userId === currentUser.username || emp.userId === currentUser.email || emp.userId === currentUser.id
            );
          }

          // Buscar elemento totalEmpleados de forma segura
          const totalEmpleadosElement = document.getElementById('totalEmpleados');
          if (totalEmpleadosElement) {
            // Solo mostrar empleados si hay horas trabajadas
            if (totalHorasTrabajadas > 0) {
              totalEmpleadosElement.textContent = empleados.length;
              console.log('✅ Total empleados actualizado:', empleados.length);
            } else {
              totalEmpleadosElement.textContent = '0';
              console.log('ℹ️ No hay horas trabajadas, mostrando 0 empleados');
            }
          } else {
            console.log('⚠️ Elemento totalEmpleados no encontrado');
          }

          // Comprobantes FILTRADOS POR USUARIO - SOLO DESDE FIREBASE
          let comprobantes = [];

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
            try {
              const comprobantesSnapshot = await firebase
                .firestore()
                .collection('comprobantes')
                .where('userId', '==', currentUser.id)
                .get();

              if (!comprobantesSnapshot.empty) {
                comprobantesSnapshot.forEach((doc) => {
                  comprobantes.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`✅ Comprobantes cargados desde Firebase: ${comprobantes.length}`);
              } else {
                console.log('ℹ️ No hay comprobantes en Firebase para este usuario');
              }
            } catch (firebaseError) {
              console.warn(
                '⚠️ Error cargando comprobantes desde Firebase, usando localStorage como fallback:',
                firebaseError
              );
              // Solo usar localStorage como fallback si Firebase falla
              const comprobantesLocal = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
              comprobantes = comprobantesLocal.filter(
                (comp) =>
                  comp.userId === currentUser.username ||
                  comp.userId === currentUser.email ||
                  comp.userId === currentUser.id
              );
            }
          } else {
            console.log('ℹ️ Firebase no disponible, usando localStorage para comprobantes');
            const comprobantesLocal = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
            comprobantes = comprobantesLocal.filter(
              (comp) =>
                comp.userId === currentUser.username ||
                comp.userId === currentUser.email ||
                comp.userId === currentUser.id
            );
          }

          // Buscar elemento comprobantesGenerados de forma segura
          const comprobantesElement = document.getElementById('comprobantesGenerados');
          if (comprobantesElement) {
            comprobantesElement.textContent = comprobantes.length;
            console.log('✅ Comprobantes generados actualizados:', comprobantes.length);
          } else {
            console.log('⚠️ Elemento comprobantesGenerados no encontrado');
          }

          // Calcular horas trabajadas - SOLO DESDE FIREBASE
          let registrosHoras = [];

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
            try {
              const horasSnapshot = await firebase
                .firestore()
                .collection('horas')
                .where('userId', '==', currentUser.id)
                .get();

              if (!horasSnapshot.empty) {
                horasSnapshot.forEach((doc) => {
                  registrosHoras.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`✅ Horas cargadas desde Firebase: ${registrosHoras.length}`);
              } else {
                console.log('ℹ️ No hay horas en Firebase para este usuario');
              }
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando horas desde Firebase, usando localStorage como fallback:', firebaseError);
              // Solo usar localStorage como fallback si Firebase falla
              const horasLocal = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
              registrosHoras = horasLocal.filter(
                (hr) =>
                  hr.userId === currentUser.username || hr.userId === currentUser.email || hr.userId === currentUser.id
              );
            }
          } else {
            console.log('ℹ️ Firebase no disponible, usando localStorage para horas');
            const horasLocal = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
            registrosHoras = horasLocal.filter(
              (hr) =>
                hr.userId === currentUser.username || hr.userId === currentUser.email || hr.userId === currentUser.id
            );
          }

          const totalHorasTrabajadas = registrosHoras.reduce((total, registro) => {
            const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
            const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
            const horasExtras = parseFloat(registro.horasExtras) || 0;
            const horasDominicales = parseFloat(registro.horasDominicales) || 0;
            return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
          }, 0);

          // Calcular total de salarios base SOLO si hay horas trabajadas
          let totalSalarios = 0;
          if (totalHorasTrabajadas > 0) {
            totalSalarios = empleados.reduce((total, empleado) => {
              if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
                return total;
              }
              const salario = parseFloat(empleado.salario);
              if (!isNaN(salario) && salario > 0) {
                return total + salario;
              }
              return total;
            }, 0);
          }

          // Si no hay horas trabajadas, el total de salarios debe ser 0
          const totalSalariosFinal = totalHorasTrabajadas > 0 ? totalSalarios : 0;

          // Formatear y mostrar datos de forma segura
          formatearYMostrarDatos(totalSalariosFinal, totalHorasTrabajadas);

          // Cargar actividad reciente de forma segura
          if (typeof cargarActividadRecienteContinuacion === 'function') {
            cargarActividadRecienteContinuacion();
          } else {
            console.log('⚠️ Función cargarActividadRecienteContinuacion no disponible');
          }

          console.log('✅ Estadísticas cargadas exitosamente');
        } catch (error) {
          console.error('❌ Error en cargarEstadisticasLocalStorage:', error);
          // NO redirigir al login por errores de estadísticas
        }
      }

      // Función para formatear y mostrar datos - SISTEMA AISLADO
      function formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas) {
        try {
          console.log('💹 Formateando datos:', { totalSalarios, totalHorasTrabajadas });

          // Formatear salario con solo 1 decimal y ajustar tamaño
          const formatearMoneda = (monto) => {
            if (monto === 0) return '$0';
            if (monto < 1000) return `$${monto.toFixed(1)}`;
            if (monto < 1000000) return `$${(monto / 1000).toFixed(1)}K`;
            if (monto < 1000000000) return `$${(monto / 1000000).toFixed(1)}M`;
            return `$${(monto / 1000000000).toFixed(1)}B`;
          };

          // Buscar elemento totalSalarios de forma segura
          const totalSalariosElement = document.getElementById('totalSalarios');
          if (totalSalariosElement) {
            totalSalariosElement.textContent = formatearMoneda(totalSalarios);
            console.log('✅ Total salarios actualizado:', formatearMoneda(totalSalarios));
          } else {
            console.log('⚠️ Elemento totalSalarios no encontrado');
          }

          // Formatear horas con solo 1 decimal y ajustar tamaño
          const formatearHoras = (horas) => {
            if (horas === 0) return '0';
            if (horas < 100) return horas.toFixed(1);
            if (horas < 1000) return (horas / 100).toFixed(1) + 'C';
            if (horas < 1000000) return (horas / 1000).toFixed(1) + 'K';
            return (horas / 1000000).toFixed(1) + 'M';
          };

          // Buscar elemento horasTrabajadas de forma segura
          const horasTrabajadasElement = document.getElementById('horasTrabajadas');
          if (horasTrabajadasElement) {
            horasTrabajadasElement.textContent = formatearHoras(totalHorasTrabajadas);
            console.log('✅ Horas trabajadas actualizadas:', formatearHoras(totalHorasTrabajadas));
          } else {
            console.log('⚠️ Elemento horasTrabajadas no encontrado');
          }

          console.log('✅ Datos formateados y mostrados exitosamente');
        } catch (error) {
          console.error('❌ Error en formatearYMostrarDatos:', error);
          // NO redirigir al login por errores de formato
        }
      }

      // Cargar actividad reciente con fallbacks robustos
      function cargarActividadReciente() {
        try {
          const actividadReciente = document.getElementById('actividadReciente');
          if (!actividadReciente) {
            console.warn('⚠️ Elemento actividadReciente no encontrado');
            return;
          }

          // Obtener usuario actual con múltiples fallbacks

          // 1. Intentar sistema aislado
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          }

          // 2. Fallback a localStorage
          if (!currentUser) {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              try {
                currentUser = JSON.parse(userData);
              } catch (e) {
                console.warn('⚠️ Error parseando datos de usuario:', e);
              }
            }
          }

          // 3. Fallback a datos de sesión
          if (!currentUser) {
            const sessionData = localStorage.getItem('axyra_session');
            if (sessionData) {
              try {
                currentUser = JSON.parse(sessionData);
              } catch (e) {
                console.warn('⚠️ Error parseando datos de sesión:', e);
              }
            }
          }

          // 4. Usuario por defecto si no hay ninguno
          if (!currentUser) {
            currentUser = { username: 'admin', id: 'default' };
            console.log('ℹ️ Usando usuario por defecto para actividad reciente');
          }

          // Cargar datos con fallbacks robustos
          let empleados = [];
          let comprobantes = [];

          try {
            // Intentar cargar empleados
            const empleadosData = localStorage.getItem('axyra_empleados');
            if (empleadosData) {
              empleados = JSON.parse(empleadosData);
              console.log('📊 Empleados cargados del localStorage:', empleados.length);

              // Filtrar por usuario si es posible
              if (currentUser.username && currentUser.username !== 'admin') {
                const empleadosFiltrados = empleados.filter(
                  (emp) =>
                    emp.userId === currentUser.username ||
                    emp.userId === currentUser.email ||
                    emp.userId === currentUser.id
                );
                empleados = empleadosFiltrados;
                console.log('👤 Empleados filtrados para usuario:', empleados.length, 'Usuario:', currentUser.username);
              } else {
                console.log('👤 Mostrando todos los empleados (usuario admin)');
              }
            }
          } catch (e) {
            console.warn('⚠️ Error cargando empleados:', e);
            empleados = [];
          }

          try {
            // Intentar cargar comprobantes
            const comprobantesData = localStorage.getItem('axyra_comprobantes');
            if (comprobantesData) {
              comprobantes = JSON.parse(comprobantesData);
              console.log('📋 Comprobantes cargados del localStorage:', comprobantes.length);

              // Filtrar por usuario si es posible
              if (currentUser.username && currentUser.username !== 'admin') {
                const comprobantesFiltrados = comprobantes.filter(
                  (comp) =>
                    comp.userId === currentUser.username ||
                    comp.userId === currentUser.email ||
                    comp.userId === currentUser.id
                );
                comprobantes = comprobantesFiltrados;
                console.log(
                  '👤 Comprobantes filtrados para usuario:',
                  comprobantes.length,
                  'Usuario:',
                  currentUser.username
                );
              } else {
                console.log('👤 Mostrando todos los comprobantes (usuario admin)');
              }
            }
          } catch (e) {
            console.warn('⚠️ Error cargando comprobantes:', e);
            comprobantes = [];
          }

          let actividadHTML = '';

          // Actividad de empleados con fallback
          if (empleados && empleados.length > 0) {
            const ultimoEmpleado = empleados[empleados.length - 1];
            const nombreEmpleado = ultimoEmpleado.nombre || ultimoEmpleado.nombreCompleto || 'Empleado';
            const fecha = ultimoEmpleado.fechaCreacion || ultimoEmpleado.fecha || new Date().toLocaleDateString();

            actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Empleado agregado</div>
                  <div class="axyra-activity-time">${nombreEmpleado} - ${fecha}</div>
                </div>
              </div>
            `;

            // Mostrar total de empleados
            actividadHTML += `
              <div class="axyra-activity-item">
                <div class="axyra-activity-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="axyra-activity-content">
                  <div class="axyra-activity-title">Total de empleados</div>
                  <div class="axyra-activity-time">${empleados.length} empleados registrados</div>
                </div>
              </div>
            `;
          } else {
            // Mostrar mensaje cuando no hay empleados
            actividadHTML += `
              <div class="axyra-activity-item">
                <div class="axyra-activity-icon">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="axyra-activity-content">
                  <div class="axyra-activity-title">Sin empleados registrados</div>
                  <div class="axyra-activity-time">Agrega tu primer empleado</div>
                        </div>
                    </div>
                `;
          }

          // Actividad de comprobantes con fallback
          if (comprobantes && comprobantes.length > 0) {
            const ultimoComprobante = comprobantes[comprobantes.length - 1];
            const empleadoComprobante = ultimoComprobante.empleado || ultimoComprobante.nombreEmpleado || 'Empleado';
            const fechaComprobante =
              ultimoComprobante.fecha || ultimoComprobante.fechaGeneracion || new Date().toLocaleDateString();

            actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Comprobante generado</div>
                  <div class="axyra-activity-time">${empleadoComprobante} - ${fechaComprobante}</div>
                </div>
              </div>
            `;
          } else {
            // Mostrar mensaje cuando no hay comprobantes
            actividadHTML += `
              <div class="axyra-activity-item">
                <div class="axyra-activity-icon">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="axyra-activity-content">
                  <div class="axyra-activity-title">Sin comprobantes generados</div>
                  <div class="axyra-activity-time">Genera tu primer comprobante</div>
                        </div>
                    </div>
                `;
          }

          // Actividad del sistema
          actividadHTML += `
                <div class="axyra-activity-item">
                    <div class="axyra-activity-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="axyra-activity-content">
                        <div class="axyra-activity-title">Sesión iniciada</div>
                <div class="axyra-activity-time">${
                  currentUser.username || 'Usuario'
                } - ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;

          // Mostrar actividad
          actividadReciente.innerHTML = actividadHTML;

          console.log('✅ Actividad reciente cargada:', {
            empleados: empleados.length,
            comprobantes: comprobantes.length,
            usuario: currentUser.username,
          });
        } catch (error) {
          console.error('❌ Error en cargarActividadReciente:', error);
          // Fallback final con mensaje de error
          const actividadReciente = document.getElementById('actividadReciente');
          if (actividadReciente) {
            actividadReciente.innerHTML = `
              <div class="axyra-activity-item">
                <div class="axyra-activity-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="axyra-activity-content">
                  <div class="axyra-activity-title">Error cargando actividad</div>
                  <div class="axyra-activity-time">Intenta recargar la página</div>
                </div>
              </div>
            `;
          }
        }
      }

      // Funciones para mostrar detalles de las estadísticas
      function mostrarDetalleEmpleados() {
        try {
          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('❌ No hay usuario autenticado', 'error');
            return;
          }

          // Obtener empleados del localStorage (que ya fueron filtrados por Firebase)
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          // Filtrar por usuario actual usando la misma lógica que cargarActividadReciente
          const empleadosFiltrados = empleados.filter(
            (emp) =>
              emp.userId === currentUser.username ||
              emp.userId === currentUser.email ||
              emp.userId === currentUser.id ||
              !emp.userId // Incluir empleados sin userId (datos globales)
          );

          let detalleHTML = '<h4>📋 Lista de Empleados</h4>';
          if (empleadosFiltrados.length > 0) {
            detalleHTML += '<div class="axyra-empleados-lista">';
            empleadosFiltrados.forEach((emp) => {
              detalleHTML += `
                <div class="axyra-empleado-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre || 'Sin nombre'}</strong>
                    <span>${emp.cargo || 'Sin cargo'} - ${emp.departamento || 'Sin departamento'}</span>
                    <span>Salario: $${emp.salario?.toLocaleString('es-CO') || '0'}</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados para este usuario</p>';
          }

          mostrarModal('Detalle de Empleados', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de empleados:', error);
          mostrarMensaje('❌ Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleHoras() {
        try {
          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('❌ No hay usuario autenticado', 'error');
            return;
          }

          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
            (hr) =>
              hr.userId === currentUser.username ||
              hr.userId === currentUser.email ||
              hr.userId === currentUser.id ||
              !hr.userId // Incluir horas sin userId (datos globales)
          );

          let detalleHTML = '<h4>⏰ Detalle de Horas Trabajadas</h4>';
          if (registrosHoras.length > 0) {
            detalleHTML += '<div class="axyra-horas-lista">';
            registrosHoras.forEach((hr) => {
              const totalHoras =
                (parseFloat(hr.horasOrdinarias) || 0) +
                (parseFloat(hr.horasNocturnas) || 0) +
                (parseFloat(hr.horasExtras) || 0) +
                (parseFloat(hr.horasDominicales) || 0);
              detalleHTML += `
                <div class="axyra-hora-item">
                  <div class="axyra-hora-info">
                    <strong>${hr.empleado || 'Sin empleado'}</strong>
                    <span>Fecha: ${hr.fecha || 'Sin fecha'}</span>
                    <span>Total: ${totalHoras} horas</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay registros de horas</p>';
          }

          mostrarModal('Detalle de Horas', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de horas:', error);
          mostrarMensaje('❌ Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleComprobantes() {
        try {
          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('❌ No hay usuario autenticado', 'error');
            return;
          }

          // Obtener comprobantes del localStorage, incluyendo los del usuario actual y los globales (sin userId)
          const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
            (comp) => !comp.userId || comp.userId === currentUser.username
          );

          let detalleHTML = '<h4>🧾 Detalle de Comprobantes</h4>';
          if (comprobantes.length > 0) {
            detalleHTML += '<div class="axyra-comprobantes-lista">';
            comprobantes.forEach((comp) => {
              detalleHTML += `
                <div class="axyra-comprobante-item">
                  <div class="axyra-comprobante-info">
                    <strong>${comp.numeroFactura || 'Sin número'}</strong>
                    <span>${comp.encargado || 'Sin encargado'} - ${comp.area || 'Sin área'}</span>
                    <span>$${comp.monto?.toLocaleString('es-CO') || '0'}</span>
                </div>
                <button class="axyra-btn axyra-btn-sm axyra-btn-secondary" onclick="descargarComprobante('${comp.id}')">
                  <i class="fas fa-download"></i> Descargar
                </button>
              </div>
            `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay comprobantes generados</p>';
          }

          mostrarModal('Detalle de Comprobantes', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de comprobantes:', error);
          mostrarMensaje('❌ Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleSalarios() {
        try {
          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('❌ No hay usuario autenticado', 'error');
            return;
          }

          // Obtener horas del localStorage, incluyendo las del usuario actual y las globales (sin userId)
          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
            (hr) => !hr.userId || hr.userId === currentUser.username
          );

          const totalHorasTrabajadas = registrosHoras.reduce((total, registro) => {
            const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
            const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
            const horasExtras = parseFloat(registro.horasExtras) || 0;
            const horasDominicales = parseFloat(registro.horasDominicales) || 0;
            return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
          }, 0);

          if (totalHorasTrabajadas === 0) {
            mostrarModal(
              'Detalle de Salarios',
              '<h4>💰 Detalle de Salarios</h4><p>No hay horas registradas para calcular salarios.</p>'
            );
            return;
          }

          // Obtener empleados del localStorage, incluyendo los del usuario actual y los globales (sin userId)
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => !emp.userId || emp.userId === currentUser.username
          );

          let detalleHTML = '<h4>💰 Detalle de Salarios</h4>';
          if (empleados.length > 0) {
            detalleHTML += '<div class="axyra-salarios-lista">';
            empleados.forEach((emp) => {
              detalleHTML += `
                <div class="axyra-salario-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre || 'Sin nombre'}</strong>
                    <span>${emp.cargo || 'Sin cargo'}</span>
                    <span class="axyra-salario-monto">Salario base configurado: $${
                      emp.salario?.toLocaleString('es-CO') || '0'
                    }</span>
              </div>
              </div>
              `;
            });
            detalleHTML += `
              <div class="axyra-salario-total">
                <strong>Total Empleados: ${empleados.length}</strong>
            </div>
          `;
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados</p>';
          }

          mostrarModal('Detalle de Salarios', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de salarios:', error);
          mostrarMensaje('❌ Error al mostrar detalles', 'error');
        }
      }

      // Función para mostrar mensajes
      function mostrarMensaje(mensaje, tipo = 'info') {
        // Remover mensajes existentes
        const existingMessages = document.querySelectorAll('.axyra-message');
        existingMessages.forEach((msg) => msg.remove());

        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">×</button>
              </div>
        `;

        document.body.appendChild(mensajeDiv);

        // Auto-remover después de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Función para mostrar modal
      function mostrarModal(titulo, contenido) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">×</button>
            </div>
            <div class="axyra-modal-body">
              ${contenido}
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-primary" onclick="cerrarModal(this)">
                <i class="fas fa-check"></i> Entendido
              </button>
              </div>
            </div>
          `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Función para descargar comprobante
      function descargarComprobante(comprobanteId) {
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
        const comprobante = comprobantes.find((c) => c.id === comprobanteId);

        if (comprobante) {
          // Crear contenido del comprobante
          const contenido = `
            COMPROBANTE: ${comprobante.numeroFactura}
            FECHA: ${comprobante.fecha}
            ENCARGADO: ${comprobante.encargado}
            ÁREA: ${comprobante.area}
            MONTO: $${comprobante.monto?.toLocaleString('es-CO') || '0'}
            MÉTODO DE PAGO: ${comprobante.metodoPago}
            DESCRIPCIÓN: ${comprobante.descripcion}
          `;

          // Crear y descargar archivo
          const blob = new Blob([contenido], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `comprobante_${comprobante.numeroFactura}.txt`;
          a.click();
          window.URL.revokeObjectURL(url);
        }
      }

      // Función para mostrar modal de acción (navegación)
      function mostrarModalAccion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">×</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="ejecutarAccion('${accion}')">
                <i class="fas fa-check"></i> Continuar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Función para mostrar modal de confirmación (acciones destructivas)
      function mostrarModalConfirmacion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">×</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-danger" onclick="ejecutarAccionConfirmada('${accion}')">
                <i class="fas fa-exclamation-triangle"></i> Confirmar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Función para ejecutar acciones de navegación
      function ejecutarAccion(accion) {
        // Cerrar modal
        document.querySelector('.axyra-modal').remove();

        // Ejecutar acción según el tipo
        switch (accion) {
          case 'empleados':
            window.location.href = '../empleados/empleados.html';
            break;
          case 'horas':
            window.location.href = '../horas/gestionar_horas.html';
            break;
          case 'nomina':
            window.location.href = '../nomina/gestionar_nomina.html';
            break;
          case 'cuadre':
            window.location.href = '../cuadre_caja/cuadre_caja.html';
            break;
          default:
            console.log('Acción no reconocida:', accion);
        }
      }

      // Función para ejecutar acciones confirmadas
      function ejecutarAccionConfirmada(accion) {
        // Cerrar modal
        cerrarModalesExistentes();

        // Ejecutar acción según el tipo
        switch (accion) {
          case 'limpiarDatosCorruptos':
            limpiarDatosCorruptos();
            break;
          case 'resetearLocalStorage':
            resetearLocalStorage();
            break;
          case 'crearDatosPrueba':
            crearDatosPrueba();
            break;
          default:
            console.log('Acción confirmada no reconocida:', accion);
        }
      }

      // Función para cerrar un modal específico
      function cerrarModal(elemento) {
        const modal = elemento.closest('.axyra-modal');
        if (modal) {
          modal.remove();
        }
      }

      // Función para cerrar todos los modales existentes
      function cerrarModalesExistentes() {
        const modales = document.querySelectorAll('.axyra-modal');
        modales.forEach((modal) => modal.remove());
      }

      // Ver todas las tareas
      function verTodasLasTareas() {
        // Crear modal para mostrar todas las tareas
        const modalHTML = `
          <div id="modalTareas" class="axyra-modal show">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-tasks"></i> Todas las Tareas
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalTareas()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-tasks-container">
                  <div class="axyra-task-filters">
                    <select id="filterPrioridad" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todas las prioridades</option>
                      <option value="Alta">Alta</option>
                      <option value="Media">Media</option>
                      <option value="Baja">Baja</option>
                    </select>
                    <select id="filterEstado" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todos los estados</option>
                      <option value="Pendiente">Pendiente</option>
                      <option value="En Progreso">En Progreso</option>
                      <option value="Completada">Completada</option>
                    </select>
                  </div>
                  <div id="listaTareasCompleta" class="axyra-tasks-list">
                    <!-- Las tareas se cargarán dinámicamente -->
                  </div>
                  <div class="axyra-task-actions">
                    <button class="axyra-btn axyra-btn-primary" onclick="agregarNuevaTarea()">
                      <i class="fas fa-plus"></i> Nueva Tarea
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        cargarTodasLasTareas();
      }

      // Cerrar modal de tareas
      function cerrarModalTareas() {
        const modal = document.getElementById('modalTareas');
        if (modal) {
          modal.remove();
        }
      }

      // Cargar todas las tareas
      function cargarTodasLasTareas() {
        const listaTareas = document.getElementById('listaTareasCompleta');
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');

        let tareasHTML = '';

        // Tareas del sistema
        const tareasSistema = [
          {
            id: 'sistema-1',
            titulo: 'Configurar zona horaria',
            descripcion: 'Establecer zona horaria para Colombia',
            prioridad: 'Baja',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
          {
            id: 'sistema-2',
            titulo: 'Configurar moneda por defecto',
            descripcion: 'Establecer COP como moneda principal',
            prioridad: 'Media',
            estado: 'Completada',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
        ];

        // Tareas basadas en empleados
        if (empleados.length === 0) {
          tareasSistema.push({
            id: 'empleado-1',
            titulo: 'Agregar primer empleado',
            descripcion: 'Registrar el primer empleado en el sistema',
            prioridad: 'Alta',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Empleado',
          });
        }

        // Tareas basadas en comprobantes
        if (comprobantes.length === 0 && empleados.length > 0) {
          tareasSistema.push({
            id: 'comprobante-1',
            titulo: 'Generar primer comprobante',
            descripcion: 'Crear el primer comprobante de pago',
            prioridad: 'Media',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Comprobante',
          });
        }

        // Mostrar todas las tareas
        tareasSistema.forEach((tarea) => {
          const prioridadClass = tarea.prioridad.toLowerCase().replace(' ', '-');
          const estadoClass = tarea.estado.toLowerCase().replace(' ', '-');

          tareasHTML += `
            <div class="axyra-task-item" data-prioridad="${tarea.prioridad}" data-estado="${tarea.estado}">
              <div class="axyra-task-header">
                <div class="axyra-task-title">${tarea.titulo}</div>
                <div class="axyra-task-meta">
                  <span class="axyra-badge axyra-badge-${prioridadClass}">${tarea.prioridad}</span>
                  <span class="axyra-badge axyra-badge-${estadoClass}">${tarea.estado}</span>
                </div>
              </div>
              <div class="axyra-task-description">${tarea.descripcion}</div>
              <div class="axyra-task-footer">
                <span class="axyra-task-type">${tarea.tipo}</span>
                <span class="axyra-task-date">${tarea.fecha}</span>
              </div>
            </div>
          `;
        });

        if (tareasHTML === '') {
          tareasHTML = '<p class="axyra-text-center">No hay tareas pendientes</p>';
        }

        listaTareas.innerHTML = tareasHTML;
      }

      // Filtrar tareas
      function filtrarTareas() {
        const prioridad = document.getElementById('filterPrioridad').value;
        const estado = document.getElementById('filterEstado').value;

        document.querySelectorAll('.axyra-task-item').forEach((item) => {
          let mostrar = true;

          if (prioridad && item.dataset.prioridad !== prioridad) {
            mostrar = false;
          }

          if (estado && item.dataset.estado !== estado) {
            mostrar = false;
          }

          item.style.display = mostrar ? 'block' : 'none';
        });
      }

      // Agregar nueva tarea
      function agregarNuevaTarea() {
        alert('📝 Funcionalidad de agregar tareas en desarrollo');
      }

      // Cargar configuración guardada
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        const zonaHoraria = localStorage.getItem('axyra_zona_horaria') || 'America/Bogota';
        const formatoFecha = localStorage.getItem('axyra_formato_fecha') || 'DD/MM/YYYY';

        // Aplicar moneda
        cambiarMoneda(moneda);

        // Aplicar zona horaria
        document.getElementById('zonaHoraria').value = zonaHoraria;

        // Aplicar formato de fecha
        document.getElementById('formatoFecha').value = formatoFecha;
      }

      // Guardar configuración
      function guardarConfiguracion() {
        const zonaHoraria = document.getElementById('zonaHoraria').value;
        const formatoFecha = document.getElementById('formatoFecha').value;

        localStorage.setItem('axyra_zona_horaria', zonaHoraria);
        localStorage.setItem('axyra_formato_fecha', formatoFecha);

        mostrarMensaje('✅ Configuración guardada', 'success');
      }

      // Inicialización completa del dashboard
      window.addEventListener('load', () => {
        try {
          console.log('🚀 Inicializando dashboard...');

          // Verificar autenticación
          const isAuthenticated = checkAuth();

          if (isAuthenticated) {
            console.log('✅ Usuario autenticado, cargando dashboard...');

            // Cargar estadísticas
            cargarEstadisticas();

            // Actualizar indicador de seguridad
            updateSecurityStatus();

            // Mostrar configuración de empresa
            mostrarConfiguracionEmpresa();

            // Configurar intervalo de actualización de seguridad
            setInterval(updateSecurityStatus, 30000); // Cada 30 segundos

            // Configurar listener para cambios en empleados
            configurarListenerCambiosEmpleados();

            console.log('✅ Dashboard completamente inicializado');
          } else {
            console.log('❌ Usuario no autenticado, mostrando mensaje...');
            // NO redirigir automáticamente
          }
        } catch (error) {
          console.error('❌ Error inicializando dashboard:', error);
          // NO redirigir automáticamente
        }
      });

      // Mostrar configuración actual de la empresa
      function mostrarConfiguracionEmpresa() {
        try {
          // Obtener usuario actual para aislamiento de datos
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          const config = JSON.parse(localStorage.getItem('axyra_configuracion') || '{}');

          if (config.nombreEmpresa) {
            console.log('🏢 Configuración de empresa cargada:', {
              nombre: config.nombreEmpresa,
              nit: config.nitEmpresa,
              direccion: config.direccionEmpresa,
            });

            // Actualizar el título del dashboard si hay configuración
            const logoTitle = document.querySelector('.axyra-logo-title');
            if (logoTitle && config.nombreEmpresa) {
              logoTitle.textContent = config.nombreEmpresa.toUpperCase();
            }
          } else {
            console.log('ℹ️ No hay configuración de empresa, usando valores por defecto');

            // Intentar obtener desde Firebase si está disponible
            if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
              try {
                firebase
                  .firestore()
                  .collection('company_config')
                  .doc(currentUser.id)
                  .get()
                  .then((doc) => {
                    if (doc.exists) {
                      const companyData = doc.data();
                      console.log('🏢 Configuración de empresa obtenida desde Firebase:', companyData);

                      // Actualizar el título del dashboard si hay configuración
                      const logoTitle = document.querySelector('.axyra-logo-title');
                      if (logoTitle && companyData.nombreEmpresa) {
                        logoTitle.textContent = companyData.nombreEmpresa.toUpperCase();
                      }
                    }
                  })
                  .catch((error) => {
                    console.log('⚠️ Error obteniendo configuración de empresa desde Firebase:', error);
                  });
              } catch (error) {
                console.log('⚠️ Firebase no disponible para configuración de empresa:', error);
              }
            }
          }
        } catch (error) {
          console.error('❌ Error mostrando configuración de empresa:', error);
        }
      }

      // Continuación de la función cargarActividadReciente
      function cargarActividadRecienteContinuacion() {
        const actividadReciente = document.getElementById('actividadReciente');

        // Obtener usuario actual para aislamiento de datos
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser || !currentUser.username) {
          console.error('No hay usuario autenticado para actividad reciente');
          return;
        }

        // Filtrar datos por usuario
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        let actividadHTML = '';

        // Actividad de empleados
        if (empleados.length > 0) {
          // Mostrar total de empleados
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Total de Empleados</div>
                            <div class="axyra-activity-time">${empleados.length} empleados registrados</div>
                        </div>
                    </div>
                `;

          // Mostrar último empleado agregado
          const ultimoEmpleado = empleados[empleados.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Último Empleado Agregado</div>
                            <div class="axyra-activity-time">${ultimoEmpleado.nombre} - ${
            ultimoEmpleado.cargo || 'Sin cargo'
          } - ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                `;

          // Mostrar lista de empleados recientes (máximo 3)
          const empleadosRecientes = empleados.slice(-3).reverse();
          empleadosRecientes.forEach((empleado) => {
            actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">${empleado.nombre}</div>
                            <div class="axyra-activity-time">${empleado.cargo || 'Sin cargo'} - ${
              empleado.cedula || 'Sin cédula'
            }</div>
                        </div>
                    </div>
                `;
          });
        }

        // Actividad de comprobantes
        if (comprobantes.length > 0) {
          const ultimoComprobante = comprobantes[comprobantes.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Comprobante generado</div>
                            <div class="axyra-activity-time">${ultimoComprobante.empleado} - ${ultimoComprobante.fecha}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad del sistema
        actividadHTML += `
                <div class="axyra-activity-item">
                    <div class="axyra-activity-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="axyra-activity-content">
                        <div class="axyra-activity-title">Sesión iniciada</div>
                        <div class="axyra-activity-time">Administrador - ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;

        if (actividadHTML === '') {
          actividadHTML = '<p class="axyra-text-center">No hay actividad reciente</p>';
        }

        actividadReciente.innerHTML = actividadHTML;
      }

      // Función para actualizar preferencias del usuario
      function actualizarPreferencias() {
        try {
          const monedaElement = document.getElementById('moneda');
          const idiomaElement = document.getElementById('idioma');

          if (!monedaElement || !idiomaElement) {
            console.log('ℹ️ Elementos de preferencias no encontrados, usando valores por defecto');
            // Usar valores por defecto
            localStorage.setItem('axyra_moneda', 'COP');
            localStorage.setItem('axyra_idioma', 'es');
            mostrarMensaje('✅ Preferencias por defecto aplicadas', 'success');
            return;
          }

          const moneda = monedaElement.value;
          const idioma = idiomaElement.value;

          // Guardar en localStorage
          localStorage.setItem('axyra_moneda', moneda);
          localStorage.setItem('axyra_idioma', idioma);

          // Mostrar mensaje de confirmación
          mostrarMensaje('✅ Preferencias actualizadas correctamente', 'success');

          // Recargar dashboard para aplicar cambios
          setTimeout(() => {
            refrescarDashboard();
          }, 1000);
        } catch (error) {
          console.error('Error actualizando preferencias:', error);
          mostrarMensaje('❌ Error al actualizar preferencias', 'error');
        }
      }

      // Inicializar dashboard
      async function initializeDashboard() {
        console.log('🚀 Inicializando dashboard...');

        // Verificar autenticación
        const isAuthenticated = await checkAuth();

        if (isAuthenticated) {
          console.log('✅ Usuario autenticado, cargando dashboard...');

          // Configurar listener de Firebase para mantener sesión
          setupFirebaseAuthListener();

          // Cargar datos después de configurar la autenticación
          setTimeout(() => {
            loadDashboardData();
            updateWelcomeMessage();
          }, 500);
        } else {
          console.log('⚠️ Usuario no autenticado, mostrando mensaje de login');
        }
      }

      // Configurar listener de Firebase para mantener sesión sincronizada
      function setupFirebaseAuthListener() {
        if (typeof firebase !== 'undefined' && firebase.auth) {
          firebase.auth().onAuthStateChanged(async function (user) {
            if (user) {
              console.log('🔥 Usuario Firebase autenticado en dashboard:', user.email);

              // Intentar obtener datos del usuario desde Firestore
              try {
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                let username = user.email.split('@')[0]; // Fallback
                let displayName = user.displayName || user.email.split('@')[0];

                if (userDoc.exists) {
                  const userData = userDoc.data();
                  username = userData.username || username;
                  displayName = userData.displayName || displayName;
                  console.log('✅ Datos del usuario obtenidos desde Firestore:', userData);
                }

                // Actualizar usuario actual
                currentUser = {
                  id: user.uid,
                  username: username,
                  email: user.email,
                  nombre: displayName,
                  rol: 'usuario',
                  createdAt: new Date().toISOString(),
                };

                // Sincronizar localStorage
                localStorage.setItem('axyra_firebase_user', JSON.stringify(user));
                localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));

                console.log('✅ Usuario actualizado:', currentUser);
              } catch (error) {
                console.error('❌ Error obteniendo datos del usuario desde Firestore:', error);

                // Usar datos básicos como fallback
                currentUser = {
                  id: user.uid,
                  username: user.email.split('@')[0],
                  email: user.email,
                  nombre: user.displayName || user.email.split('@')[0],
                  rol: 'usuario',
                  createdAt: new Date().toISOString(),
                };

                localStorage.setItem('axyra_firebase_user', JSON.stringify(user));
                localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));
              }
            } else {
              console.log('🔥 Usuario Firebase no autenticado, limpiando sesión...');

              // Limpiar sesión
              currentUser = null;
              localStorage.removeItem('axyra_firebase_user');
              localStorage.removeItem('axyra_isolated_user');

              // NO mostrar mensaje automáticamente - solo si el usuario está en la página
              if (document.visibilityState === 'visible') {
                mostrarMensajeNoAutenticado();
              }
            }
          });

          console.log('✅ Listener de Firebase configurado en dashboard');
        } else {
          console.log('⚠️ Firebase no disponible en dashboard');
        }
      }

      // Cargar datos del dashboard
      async function loadDashboardData() {
        console.log('📊 Cargando datos del dashboard...');

        try {
          // Cargar datos desde Firebase primero
          await cargarDatosFirebase();

          // Cargar estadísticas
          await loadEmpleadosStats();
          loadHorasStats();
          loadNominaStats();
          loadCuadreStats();
          loadDepartamentosStats();
          loadTareasStats();

          // Cargar gráficos
          loadCharts();

          console.log('✅ Datos del dashboard cargados correctamente');
        } catch (error) {
          console.error('❌ Error cargando datos del dashboard:', error);
          // Fallback: cargar desde localStorage
          await cargarDatosLocalStorage();
          await loadEmpleadosStats();
          loadHorasStats();
          loadNominaStats();
          loadCuadreStats();
          loadDepartamentosStats();
          loadTareasStats();
          loadCharts();
        }
      }

      // Función para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('🔄 Cargando datos desde Firebase...');

          // Verificar si Firebase está disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('⚠️ Firebase no disponible, usando localStorage como fallback');
            return;
          }

          const db = firebase.firestore();

          // Obtener userId del usuario autenticado en Firebase
          let userId = null;

          // Intentar obtener el usuario actual de Firebase Auth
          if (firebase.auth().currentUser) {
            userId = firebase.auth().currentUser.uid;
            console.log('✅ Usuario autenticado en Firebase:', userId);
          } else {
            // Fallback: buscar en localStorage o usar el usuario aislado
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              const user = JSON.parse(userData);
              userId = user.username || user.email;
            }

            if (!userId) {
              console.warn('⚠️ No se puede identificar usuario, usando localStorage');
              return;
            }
          }

          console.log('🔍 Buscando datos para userId:', userId);

          // Cargar empleados desde Firebase - buscar por userId
          try {
            const empleadosSnapshot = await db.collection('empleados').where('userId', '==', userId).get();

            empleados = empleadosSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${empleados.length} empleados cargados desde Firebase para userId: ${userId}`);

            // Si no hay empleados con ese userId, intentar buscar sin filtro
            if (empleados.length === 0) {
              console.log('🔍 No se encontraron empleados con userId específico, buscando todos...');
              const allEmpleadosSnapshot = await db.collection('empleados').get();
              empleados = allEmpleadosSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              console.log(`✅ ${empleados.length} empleados totales encontrados en Firebase`);
            }
          } catch (error) {
            console.warn('⚠️ Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar horas desde Firebase
          try {
            const horasSnapshot = await db.collection('horas').where('userId', '==', userId).get();

            horas = horasSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${horas.length} horas cargadas desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando horas desde Firebase:', error);
            horas = [];
          }

          // Cargar comprobantes desde Firebase
          try {
            const comprobantesSnapshot = await db.collection('comprobantes').where('userId', '==', userId).get();

            comprobantes = comprobantesSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${comprobantes.length} comprobantes cargados desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando comprobantes desde Firebase:', error);
            comprobantes = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_horas', JSON.stringify(horas));
          localStorage.setItem('axyra_comprobantes', JSON.stringify(comprobantes));
        } catch (error) {
          console.error('❌ Error cargando datos desde Firebase:', error);
        }
      }

      // Función para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('🔄 Cargando datos desde localStorage...');

          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username || e.userId === currentUser?.email;
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return h.userId === currentUser?.username || h.userId === currentUser?.email;
            });
          }

          // Cargar comprobantes
          const comprobantesData = localStorage.getItem('axyra_comprobantes');
          if (comprobantesData) {
            comprobantes = JSON.parse(comprobantesData);
            // Filtrar por usuario actual
            comprobantes = comprobantes.filter((c) => {
              if (!c.userId) return true; // Datos globales
              return c.userId === currentUser?.username || c.userId === currentUser?.email;
            });
          }

          console.log(
            `✅ Datos cargados desde localStorage: ${empleados.length} empleados, ${horas.length} horas, ${comprobantes.length} comprobantes`
          );
        } catch (error) {
          console.error('❌ Error cargando datos desde localStorage:', error);
        }
      }

      // Actualizar mensaje de bienvenida
      function updateWelcomeMessage() {
        try {
          if (currentUser) {
            const welcomeTitle = document.getElementById('welcomeTitle');
            if (welcomeTitle) {
              welcomeTitle.textContent = `¡Bienvenido, ${currentUser.username || currentUser.nombre}!`;
            }
          }

          // Actualizar hora y fecha
          updateTimeAndDate();

          // Actualizar información de la empresa
          updateCompanyInfo();
        } catch (error) {
          console.error('❌ Error actualizando bienvenida:', error);
        }
      }

      // Función para actualizar hora y fecha
      function updateTimeAndDate() {
        try {
          const now = new Date();
          const timeElement = document.getElementById('welcomeTime');

          if (timeElement) {
            const timeString = now.toLocaleTimeString('es-CO', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: true,
            });
            const dateString = now.toLocaleDateString('es-CO', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            });

            timeElement.innerHTML = `
              <i class="fas fa-clock"></i> ${timeString}
              <br>
              <i class="fas fa-calendar"></i> ${dateString}
            `;
          }
        } catch (error) {
          console.error('❌ Error actualizando hora y fecha:', error);
        }
      }

      // Función para actualizar información de la empresa con base de datos local robusta
      function updateCompanyInfo() {
        try {
          const companyNameElement = document.getElementById('companyName');
          const companyNITElement = document.getElementById('companyNIT');

          if (!companyNameElement || !companyNITElement) {
            console.warn('⚠️ Elementos de información de empresa no encontrados');
            return;
          }

          // Obtener información de empresa con múltiples fallbacks
          let companyInfo = null;

          // 1. Intentar obtener desde configuración local
          const config = localStorage.getItem('axyra_configuracion');
          if (config) {
            try {
              const configData = JSON.parse(config);
              if (configData.nombreEmpresa || configData.nit) {
                companyInfo = {
                  nombreEmpresa: configData.nombreEmpresa,
                  nit: configData.nit,
                  direccion: configData.direccionEmpresa,
                  telefono: configData.telefonoEmpresa,
                  email: configData.emailEmpresa,
                  sitioWeb: configData.sitioWebEmpresa,
                };
              }
            } catch (e) {
              console.warn('⚠️ Error parseando configuración local:', e);
            }
          }

          // 2. Intentar obtener desde base de datos local de empresa
          if (!companyInfo) {
            const empresaData = localStorage.getItem('axyra_empresa_info');
            if (empresaData) {
              try {
                companyInfo = JSON.parse(empresaData);
              } catch (e) {
                console.warn('⚠️ Error parseando datos de empresa:', e);
              }
            }
          }

          // 3. Intentar obtener desde Firebase si está disponible
          if (!companyInfo && typeof firebase !== 'undefined' && firebase.firestore) {
            try {
              // Obtener usuario actual
              if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                currentUser = window.axyraIsolatedAuth.getCurrentUser();
              } else {
                const userData = localStorage.getItem('axyra_isolated_user');
                if (userData) {
                  currentUser = JSON.parse(userData);
                }
              }

              if (currentUser && (currentUser.id || currentUser.username)) {
                const userId = currentUser.id || currentUser.username;
                firebase
                  .firestore()
                  .collection('company_config')
                  .doc(userId)
                  .get()
                  .then((doc) => {
                    if (doc.exists) {
                      const companyData = doc.data();
                      companyInfo = {
                        nombreEmpresa: companyData.nombreEmpresa,
                        nit: companyData.nit,
                        direccion: companyData.direccion,
                        telefono: companyData.telefono,
                        email: companyData.email,
                        sitioWeb: companyData.sitioWeb,
                      };

                      // Guardar en base de datos local para futuras consultas
                      localStorage.setItem('axyra_empresa_info', JSON.stringify(companyInfo));

                      // Actualizar UI
                      actualizarUIEmpresa(companyInfo);
                    } else {
                      // Crear configuración por defecto
                      crearConfiguracionEmpresaPorDefecto();
                    }
                  })
                  .catch((error) => {
                    console.log('⚠️ Error obteniendo configuración de empresa desde Firebase:', error);
                    crearConfiguracionEmpresaPorDefecto();
                  });
              } else {
                crearConfiguracionEmpresaPorDefecto();
              }
            } catch (error) {
              console.log('⚠️ Firebase no disponible para configuración de empresa:', error);
              crearConfiguracionEmpresaPorDefecto();
            }
          } else if (!companyInfo) {
            // 4. Crear configuración por defecto si no hay datos
            crearConfiguracionEmpresaPorDefecto();
          }

          // Actualizar UI si tenemos información
          if (companyInfo) {
            actualizarUIEmpresa(companyInfo);
          }
        } catch (error) {
          console.error('❌ Error actualizando información de empresa:', error);
          // Fallback final
          const companyNameElement = document.getElementById('companyName');
          const companyNITElement = document.getElementById('companyNIT');
          if (companyNameElement) companyNameElement.textContent = 'AXYRA';
          if (companyNITElement) companyNITElement.textContent = 'NIT: Pendiente';
        }
      }

      // Función para crear configuración de empresa por defecto
      function crearConfiguracionEmpresaPorDefecto() {
        const companyInfo = {
          nombreEmpresa: 'AXYRA',
          nit: 'Pendiente',
          direccion: 'Dirección pendiente',
          telefono: 'Teléfono pendiente',
          email: 'email@empresa.com',
          sitioWeb: 'www.empresa.com',
          fechaCreacion: new Date().toISOString(),
          version: '1.0',
        };

        // Guardar en base de datos local
        localStorage.setItem('axyra_empresa_info', JSON.stringify(companyInfo));

        // Actualizar UI
        actualizarUIEmpresa(companyInfo);

        console.log('ℹ️ Configuración de empresa por defecto creada');
      }

      // Función para actualizar UI de empresa
      function actualizarUIEmpresa(companyInfo) {
        const companyNameElement = document.getElementById('companyName');
        const companyNITElement = document.getElementById('companyNIT');

        if (companyNameElement) {
          companyNameElement.textContent = companyInfo.nombreEmpresa || 'AXYRA';
        }

        if (companyNITElement) {
          companyNITElement.textContent = `NIT: ${companyInfo.nit || 'Pendiente'}`;
        }

        console.log('✅ Información de empresa actualizada:', companyInfo.nombreEmpresa);
      }

      // Función para sincronizar información de empresa con Firebase
      async function sincronizarEmpresaConFirebase() {
        try {
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.log('ℹ️ Firebase no disponible para sincronización');
            return;
          }

          const companyInfo = localStorage.getItem('axyra_empresa_info');
          if (!companyInfo) {
            console.log('ℹ️ No hay información de empresa para sincronizar');
            return;
          }

          const companyData = JSON.parse(companyInfo);

          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (currentUser && (currentUser.id || currentUser.username)) {
            const userId = currentUser.id || currentUser.username;

            await firebase
              .firestore()
              .collection('company_config')
              .doc(userId)
              .set({
                ...companyData,
                ultimaSincronizacion: new Date().toISOString(),
                userId: userId,
              });

            console.log('✅ Información de empresa sincronizada con Firebase');
          }
        } catch (error) {
          console.error('❌ Error sincronizando empresa con Firebase:', error);
        }
      }

      // Funciones para cargar estadísticas básicas
      async function loadEmpleadosStats() {
        try {
          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
            try {
              console.log('🔥 Cargando empleados desde Firebase...');
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              if (!empleadosSnapshot.empty) {
                const empleados = [];
                empleadosSnapshot.forEach((doc) => {
                  empleados.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });

                console.log(`✅ Empleados cargados desde Firebase: ${empleados.length}`);
                document.getElementById('totalEmpleados').textContent = empleados.length;
                return;
              } else {
                console.log('ℹ️ No hay empleados en Firebase para este usuario');
                document.getElementById('totalEmpleados').textContent = '0';
                return;
              }
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando desde Firebase, usando localStorage:', firebaseError);
            }
          }

          // Fallback a localStorage con filtrado por usuario
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const empleadosFiltrados = empleados.filter(
            (emp) =>
              !emp.userId ||
              emp.userId === currentUser?.username ||
              emp.userId === currentUser?.email ||
              emp.userId === currentUser?.id
          );

          // Verificar si hay horas trabajadas
          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const horasFiltradas = registrosHoras.filter(
            (hr) =>
              !hr.userId ||
              hr.userId === currentUser?.username ||
              hr.userId === currentUser?.email ||
              hr.userId === currentUser?.id
          );

          const totalHorasTrabajadas = horasFiltradas.reduce((sum, h) => sum + (h.horas || 0), 0);

          // Solo mostrar empleados si hay horas trabajadas
          if (totalHorasTrabajadas > 0) {
            document.getElementById('totalEmpleados').textContent = empleadosFiltrados.length;
          } else {
            document.getElementById('totalEmpleados').textContent = '0';
          }
        } catch (error) {
          console.error('❌ Error cargando estadísticas de empleados:', error);
          document.getElementById('totalEmpleados').textContent = '0';
        }
      }

      function loadHorasStats() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const horasFiltradas = horas.filter(
            (h) =>
              !h.userId ||
              h.userId === currentUser?.username ||
              h.userId === currentUser?.email ||
              h.userId === currentUser?.id
          );
          const totalHoras = horasFiltradas.reduce((sum, h) => sum + (h.horas || 0), 0);
          document.getElementById('horasTrabajadas').textContent = totalHoras;
        } catch (error) {
          console.error('❌ Error cargando estadísticas de horas:', error);
          document.getElementById('horasTrabajadas').textContent = '0';
        }
      }

      function loadNominaStats() {
        try {
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const nominasFiltradas = nominas.filter(
            (n) =>
              !n.userId ||
              n.userId === currentUser?.username ||
              n.userId === currentUser?.email ||
              n.userId === currentUser?.id
          );
          const totalNominas = nominasFiltradas.length;

          // Usar el elemento correcto que existe en el HTML
          const nominasElement = document.getElementById('nominasGeneradas');
          if (nominasElement) {
            nominasElement.textContent = totalNominas;
          } else {
            console.warn('⚠️ Elemento nominasGeneradas no encontrado');
          }
        } catch (error) {
          console.error('❌ Error cargando estadísticas de nóminas:', error);
          const nominasElement = document.getElementById('nominasGeneradas');
          if (nominasElement) {
            nominasElement.textContent = '0';
          }
        }
      }

      function loadCuadreStats() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          const facturasFiltradas = facturas.filter(
            (f) =>
              !f.userId ||
              f.userId === currentUser?.username ||
              f.userId === currentUser?.email ||
              f.userId === currentUser?.id
          );
          const totalFacturas = facturasFiltradas.length;

          // Usar el elemento correcto que existe en el HTML
          const facturasElement = document.getElementById('cuadresCaja');
          if (facturasElement) {
            facturasElement.textContent = totalFacturas;
          } else {
            console.warn('⚠️ Elemento cuadresCaja no encontrado');
          }
        } catch (error) {
          console.error('❌ Error cargando estadísticas de facturas:', error);
          const facturasElement = document.getElementById('cuadresCaja');
          if (facturasElement) {
            facturasElement.textContent = '0';
          }
        }
      }

      function loadDepartamentosStats() {
        try {
          const departamentos = JSON.parse(localStorage.getItem('axyra_departamentos') || '[]');
          const totalDepartamentos = departamentos.length;

          const departamentosElement = document.getElementById('departamentos');
          if (departamentosElement) {
            departamentosElement.textContent = totalDepartamentos;
          } else {
            console.warn('⚠️ Elemento departamentos no encontrado');
          }
        } catch (error) {
          console.error('❌ Error cargando estadísticas de departamentos:', error);
        }
      }

      function loadTareasStats() {
        try {
          const tareas = JSON.parse(localStorage.getItem('axyra_tareas') || '[]');
          const tareasPendientes = tareas.filter((t) => !t.completada).length;

          const tareasElement = document.getElementById('tareasPendientes');
          if (tareasElement) {
            tareasElement.textContent = tareasPendientes;
          } else {
            console.warn('⚠️ Elemento tareasPendientes no encontrado');
          }
        } catch (error) {
          console.error('❌ Error cargando estadísticas de tareas:', error);
        }
      }

      function loadCharts() {
        // Por ahora solo cargar datos básicos
        console.log('📊 Gráficos cargados (básico)');

        // Verificar si hay datos para mostrar gráficos
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

          if (empleados.length === 0 || horas.length === 0) {
            console.log('ℹ️ No hay suficientes datos para mostrar gráficos');
            return;
          }

          console.log('✅ Datos suficientes para gráficos disponibles');
        } catch (error) {
          console.error('❌ Error verificando datos para gráficos:', error);
        }
      }

      // Función para actualizar username
      async function actualizarUsername() {
        try {
          const usernameInput = document.getElementById('usernameInput');
          if (!usernameInput) {
            console.log('ℹ️ Campo usernameInput no encontrado, usando valor por defecto');
            // Usar valor por defecto del usuario actual
            if (currentUser && currentUser.username) {
              mostrarMensaje('✅ Usuario actualizado: ' + currentUser.username, 'success');
            } else {
              mostrarMensaje('ℹ️ No hay cambios en el usuario', 'info');
            }
            return;
          }

          const newUsername = usernameInput.value.trim();

          if (!newUsername) {
            mostrarMensaje('❌ El nombre de usuario no puede estar vacío', 'error');
            return;
          }

          if (newUsername.length < 3) {
            mostrarMensaje('❌ El nombre de usuario debe tener al menos 3 caracteres', 'error');
            return;
          }

          // Actualizar en Firebase si está disponible
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser && currentUser.id) {
            try {
              await firebase.firestore().collection('users').doc(currentUser.id).update({
                username: newUsername,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              console.log('✅ Username actualizado en Firebase');
            } catch (firebaseError) {
              console.warn('⚠️ Error actualizando en Firebase:', firebaseError);
            }
          }

          // Actualizar en localStorage
          if (currentUser) {
            currentUser.username = newUsername;
            localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));

            // Actualizar en la interfaz
            document.getElementById('welcomeTitle').textContent = `¡Bienvenido, ${newUsername}!`;

            mostrarMensaje('✅ Nombre de usuario actualizado correctamente', 'success');
          } else {
            mostrarMensaje('❌ No hay usuario autenticado', 'error');
          }
        } catch (error) {
          console.error('❌ Error actualizando username:', error);
          mostrarMensaje('❌ Error al actualizar nombre de usuario', 'error');
        }
      }

      // Función para mostrar modal de cambio de contraseña
      function mostrarModalCambiarPassword() {
        const modalHTML = `
          <div id="modalCambiarPassword" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-key" style="color: #3b82f6;"></i> Cambiar Contraseña
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalCambiarPassword()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <form id="formCambiarPassword" class="axyra-form">
                  <div class="axyra-form-group">
                    <label for="currentPassword">Contraseña Actual</label>
                    <input type="password" id="currentPassword" required>
                  </div>
                  <div class="axyra-form-group">
                    <label for="newPassword">Nueva Contraseña</label>
                    <input type="password" id="newPassword" required>
                    <small>Mínimo 8 caracteres, incluir mayúscula y número</small>
                  </div>
                  <div class="axyra-form-group">
                    <label for="confirmNewPassword">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirmNewPassword" required>
                  </div>
                </form>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCambiarPassword()">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="axyra-btn axyra-btn-primary" onclick="confirmarCambioPassword()">
                  <i class="fas fa-save"></i> Cambiar Contraseña
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Función para cerrar modal de cambio de contraseña
      function cerrarModalCambiarPassword() {
        const modal = document.getElementById('modalCambiarPassword');
        if (modal) {
          modal.remove();
        }
      }

      // Función para confirmar cambio de contraseña
      function confirmarCambioPassword() {
        try {
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmNewPassword').value;

          if (!currentPassword || !newPassword || !confirmPassword) {
            mostrarMensaje('❌ Todos los campos son obligatorios', 'error');
            return;
          }

          if (newPassword.length < 8) {
            mostrarMensaje('❌ La nueva contraseña debe tener al menos 8 caracteres', 'error');
            return;
          }

          if (!/(?=.*[A-Z])(?=.*\d)/.test(newPassword)) {
            mostrarMensaje('❌ La nueva contraseña debe incluir al menos una mayúscula y un número', 'error');
            return;
          }

          if (newPassword !== confirmPassword) {
            mostrarMensaje('❌ Las contraseñas no coinciden', 'error');
            return;
          }

          // Aquí se implementaría la lógica real de cambio de contraseña
          // Por ahora solo simulamos el éxito
          mostrarMensaje('✅ Contraseña cambiada correctamente', 'success');
          cerrarModalCambiarPassword();
        } catch (error) {
          console.error('❌ Error cambiando contraseña:', error);
          mostrarMensaje('❌ Error al cambiar contraseña', 'error');
        }
      }

      // Función para toggle 2FA
      function toggle2FA() {
        try {
          const btn2FA = document.getElementById('btn2FA');
          if (!btn2FA) {
            console.log('ℹ️ Botón 2FA no encontrado, simulando toggle');
            mostrarMensaje('✅ Autenticación de dos factores configurada', 'success');
            return;
          }

          const isEnabled = btn2FA.textContent.includes('Deshabilitado');

          if (isEnabled) {
            // Habilitar 2FA
            btn2FA.textContent = 'Habilitado';
            btn2FA.className = 'axyra-btn axyra-btn-success axyra-btn-small';
            mostrarMensaje('✅ Autenticación 2FA habilitada', 'success');
          } else {
            // Deshabilitar 2FA
            btn2FA.textContent = 'Deshabilitado';
            btn2FA.className = 'axyra-btn axyra-btn-secondary axyra-btn-small';
            mostrarMensaje('ℹ️ Autenticación 2FA deshabilitada', 'info');
          }
        } catch (error) {
          console.error('❌ Error toggle 2FA:', error);
          mostrarMensaje('❌ Error al cambiar 2FA', 'error');
        }
      }

      // Función para enviar verificación de email
      function enviarVerificacionEmail() {
        try {
          const btnVerificar = document.getElementById('btnVerificar');
          if (!btnVerificar) {
            console.log('ℹ️ Botón de verificación no encontrado, simulando verificación');
            mostrarMensaje('✅ Email verificado correctamente', 'success');
            return;
          }

          const originalText = btnVerificar.textContent;

          // Simular envío
          btnVerificar.textContent = 'Enviando...';
          btnVerificar.disabled = true;

          setTimeout(() => {
            btnVerificar.textContent = 'Verificado';
            btnVerificar.className = 'axyra-btn axyra-btn-success axyra-btn-small';
            btnVerificar.disabled = true;

            // Actualizar estado en la interfaz
            const emailStatus = document.getElementById('emailStatus');
            if (emailStatus) {
              emailStatus.innerHTML = '<span style="color: #10b981;">✓ Verificado</span>';
            }

            mostrarMensaje('✅ Email verificado correctamente', 'success');
          }, 2000);
        } catch (error) {
          console.error('❌ Error verificando email:', error);
          mostrarMensaje('❌ Error al verificar email', 'error');

          // Restaurar botón si existe
          if (btnVerificar) {
            btnVerificar.textContent = originalText;
            btnVerificar.disabled = false;
          }
        }
      }

      // Función para toggle recordar sesión
      function toggleRecordarSesion() {
        try {
          const checkbox = document.getElementById('recordarSesion');
          const isChecked = checkbox.checked;

          if (isChecked) {
            localStorage.setItem('axyra_remember_me', 'true');
            mostrarMensaje('✅ Sesión será recordada', 'success');
          } else {
            localStorage.removeItem('axyra_remember_me');
            mostrarMensaje('ℹ️ Sesión no será recordada', 'info');
          }
        } catch (error) {
          console.error('❌ Error toggle recordar sesión:', error);
          mostrarMensaje('❌ Error al cambiar preferencia', 'error');
        }
      }

      // Configurar listener para cambios en empleados
      function configurarListenerCambiosEmpleados() {
        try {
          console.log('👂 Configurando listener para cambios en empleados...');

          // Escuchar eventos personalizados
          window.addEventListener('axyraEmpleadosCambiados', async (event) => {
            console.log('📢 Evento de cambio en empleados recibido:', event.detail);

            // Verificar que el cambio sea para el usuario actual
            if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
              currentUser = window.axyraIsolatedAuth.getCurrentUser();
            } else {
              const userData = localStorage.getItem('axyra_isolated_user');
              if (userData) {
                currentUser = JSON.parse(userData);
              }
            }

            if (currentUser && event.detail.userId === (currentUser.id || currentUser.username || currentUser.email)) {
              console.log('🔄 Refrescando dashboard por cambio en empleados...');
              await cargarEstadisticas();
              cargarActividadRecienteContinuacion();
            }
          });

          // También escuchar cambios en localStorage para compatibilidad
          window.addEventListener('storage', (event) => {
            if (event.key === 'axyra_last_employee_change') {
              try {
                const changeData = JSON.parse(event.newValue);
                console.log('📢 Cambio en empleados detectado vía localStorage:', changeData);

                // Verificar que el cambio sea para el usuario actual
                if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                  currentUser = window.axyraIsolatedAuth.getCurrentUser();
                } else {
                  const userData = localStorage.getItem('axyra_isolated_user');
                  if (userData) {
                    currentUser = JSON.parse(userData);
                  }
                }

                if (
                  currentUser &&
                  changeData.userId === (currentUser.id || currentUser.username || currentUser.email)
                ) {
                  console.log('🔄 Refrescando dashboard por cambio en empleados (localStorage)...');
                  setTimeout(() => {
                    cargarEstadisticas();
                    cargarActividadRecienteContinuacion();
                  }, 100);
                }
              } catch (error) {
                console.error('❌ Error procesando cambio vía localStorage:', error);
              }
            }
          });

          // También escuchar cambios en horas para actualizar estadísticas
          window.addEventListener('storage', (event) => {
            if (event.key === 'axyra_horas') {
              try {
                console.log('📢 Cambio en horas detectado, actualizando estadísticas...');
                setTimeout(() => cargarEstadisticas(), 100);
              } catch (error) {
                console.error('❌ Error procesando cambio en horas:', error);
              }
            }
          });

          console.log('✅ Listener configurado correctamente');
        } catch (error) {
          console.error('❌ Error configurando listener:', error);
        }
      }
    </script>

    <style>
      .axyra-productivity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .axyra-productivity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
      }

      .axyra-productivity-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
      }

      .axyra-productivity-content {
        flex: 1;
      }

      .axyra-productivity-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--axyra-gray-900);
        line-height: 1;
      }

      .axyra-productivity-label {
        font-size: 0.875rem;
        color: var(--axyra-gray-600);
        margin-top: 0.25rem;
      }

      #employeeDistributionChart,
      #hoursTrendChart,
      #salaryDistributionChart,
      #productivityChart {
        position: relative;
        min-height: 300px;
      }

      /* Estilos para tarjetas clickeables */
      .axyra-stat-card.clickable {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .axyra-stat-card.clickable:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-stat-hint {
        font-size: 0.75rem;
        color: var(--axyra-gray-500);
        text-align: center;
        margin-top: 0.5rem;
        opacity: 0.8;
      }

      /* Estilos para el modal */
      .axyra-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .axyra-modal-content {
        background: white;
        border-radius: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: modalSlideIn 0.3s ease-out;
        padding: 30px;
        position: relative;
        z-index: 10000;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Estilos para tarjeta de bienvenida */
      .axyra-welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .axyra-welcome-icon {
        font-size: 48px;
        opacity: 0.9;
      }

      .axyra-welcome-content {
        flex: 1;
      }

      .axyra-welcome-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: white;
      }

      .axyra-welcome-message {
        font-size: 16px;
        margin: 0 0 15px 0;
        opacity: 0.9;
        line-height: 1.5;
      }

      .axyra-welcome-time {
        font-size: 1.1rem;
        color: #ffffff;
        margin-top: 10px;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .axyra-company-info {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .axyra-company-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
      }

      .axyra-company-nit {
        font-size: 1rem;
        color: #ffffff;
        font-weight: 600;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }

      /* Estilos para panel de configuración */
      .axyra-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .axyra-config-section {
        background: #f8fafc;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .axyra-config-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-config-item {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .axyra-config-item label {
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
      }

      .axyra-config-input {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .axyra-config-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-config-select {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .axyra-config-btn {
        padding: 10px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-config-btn:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-config-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #fed7d7;
        color: #c53030;
        display: inline-block;
      }

      .axyra-config-status.verified {
        background: #c6f6d5;
        color: #2f855a;
      }

      .axyra-2fa-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .axyra-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 14px;
        color: #4a5568;
      }

      .axyra-checkbox input[type='checkbox'] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      /* Estilos para modales */
      .axyra-modal-body {
        padding: 20px;
      }

      .axyra-modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .axyra-form-group {
        margin-bottom: 20px;
      }

      .axyra-form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .axyra-form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .axyra-form-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-form-help {
        font-size: 12px;
        color: #718096;
        margin-top: 5px;
        display: block;
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        font-size: 16px;
        padding: 5px;
        transition: color 0.3s ease;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      /* Estilos para Google Authenticator */
      .axyra-google-auth-setup {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .axyra-qr-section,
      .axyra-manual-section,
      .axyra-verification-section {
        text-align: center;
      }

      .axyra-qr-section h4,
      .axyra-manual-section h4,
      .axyra-verification-section h4 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
      }

      .axyra-qr-container {
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 12px;
        padding: 30px;
        margin: 20px 0;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .axyra-qr-container img {
        max-width: 200px;
        height: auto;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-btn-primary {
        background: #667eea;
        color: white;
        border: none;
      }

      .axyra-btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-btn-secondary {
        background: #718096;
        color: white;
        border: none;
      }

      .axyra-btn-secondary:hover {
        background: #4a5568;
        transform: translateY(-2px);
      }

      .axyra-modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 20px 20px 0 0;
      }

      .axyra-modal-header h3 {
        margin: 0;
        color: #1e293b;
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .axyra-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .axyra-modal-close:hover {
        background: #f1f5f9;
        color: #374151;
        transform: scale(1.1);
      }

      .axyra-modal-body {
        padding: 2rem;
        background: white;
      }

      .axyra-modal-footer {
        padding: 1.5rem 2rem;
        border-top: 2px solid #f1f5f9;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 0 0 20px 20px;
      }

      /* Estilos para listas de detalles */
      .axyra-empleados-lista,
      .axyra-horas-lista,
      .axyra-comprobantes-lista,
      .axyra-salarios-lista {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .axyra-empleado-item,
      .axyra-hora-item,
      .axyra-comprobante-item,
      .axyra-salario-item {
        padding: 1rem;
        border: 1px solid var(--axyra-gray-200);
        border-radius: 0.5rem;
        background: var(--axyra-gray-50);
      }

      .axyra-empleado-info,
      .axyra-hora-info,
      .axyra-comprobante-info,
      .axyra-salario-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .axyra-comprobante-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-salario-total {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--axyra-blue-50);
        border: 1px solid var(--axyra-blue-200);
        border-radius: 0.5rem;
        text-align: center;
        color: var(--axyra-blue-800);
      }

      .axyra-chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      /* Estilos para formularios del modal */
      .axyra-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .axyra-form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .axyra-form-group label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
      }

      .axyra-form-group input {
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: #f9fafb;
      }

      .axyra-form-group input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .axyra-form-group small {
        color: #6b7280;
        font-size: 0.75rem;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .axyra-productivity-grid {
          grid-template-columns: 1fr;
        }

        .axyra-productivity-item {
          flex-direction: column;
          text-align: center;
        }
      }
    </style>

    <!-- Inicialización automática del dashboard -->
    <script>
      // Inicializar dashboard cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Dashboard cargado, verificando autenticación...');

        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await initializeDashboard();
        }, 500);
      });
    </script>
  </body>
</html>
