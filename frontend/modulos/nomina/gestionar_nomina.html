<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gestión de Nómina</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="nomina-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>
    <script src="../../static/excel-export.js"></script>
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
    <script src="../../static/gmail-notifications.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Gestión de Nómina</div>
          </div>
        </div>
        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link"> <i class="fas fa-home"></i> Inicio </a>
          <a href="../dashboard/dashboard.html" class="axyra-nav-link">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="gestionar_nomina.html" class="axyra-nav-link active">
            <i class="fas fa-file-invoice-dollar"></i> Nómina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuración
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gestión de Nómina</h1>
          <p class="axyra-page-subtitle">Genera y gestiona las nóminas de tus empleados</p>
        </div>

        <!-- Botones de Acción -->
        <div class="axyra-actions-bar">
          <button class="axyra-btn axyra-btn-primary" onclick="mostrarModal('modalGenerarNomina')">
            <i class="fas fa-plus"></i> Generar Nómina
          </button>
          <button class="axyra-btn axyra-btn-secondary" onclick="exportarNomina()">
            <i class="fas fa-download"></i> Exportar a Excel
          </button>
          <button class="axyra-btn axyra-btn-success" onclick="generarComprobantePDF()">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
          <button class="axyra-btn axyra-btn-warning" onclick="mostrarModal('modalReportesAvanzados')">
            <i class="fas fa-chart-bar"></i> Reportes
          </button>
          <button class="axyra-btn axyra-btn-info" onclick="mostrarModal('modalConfiguracionNomina')">
            <i class="fas fa-cog"></i> Configuración
          </button>
        </div>

        <!-- Dashboard de Métricas -->
        <div class="axyra-metrics-dashboard">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalEmpleados">0</div>
              <div class="metric-label">Total Empleados</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalNominas">0</div>
              <div class="metric-label">Nóminas Generadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="costoTotalEmpresa">$0</div>
              <div class="metric-label">Costo Total Empresa</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalHorasTrabajadas">0 hrs</div>
              <div class="metric-label">Total Horas Trabajadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="promedioSalario">$0</div>
              <div class="metric-label">Promedio Salario</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="nominasEsteMes">0</div>
              <div class="metric-label">Nóminas Este Mes</div>
            </div>
          </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="axyra-filters">
          <div class="axyra-search-box">
            <input type="text" id="searchInput" class="axyra-form-input" placeholder="Buscar por empleado..." />
            <i class="fas fa-search"></i>
          </div>
          <select id="filterEmpleado" class="axyra-form-select">
            <option value="">Todos los empleados</option>
          </select>
          <select id="filterMes" class="axyra-form-select">
            <option value="">Todos los meses</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
          <select id="filterAnio" class="axyra-form-select">
            <option value="">Todos los años</option>
          </select>
        </div>

        <!-- Tabla de Nóminas -->
        <div class="axyra-table-container">
          <table class="axyra-table" id="nominasTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Empleado</th>
                <th>Período</th>
                <th>Horas Normales</th>
                <th>Horas Extras</th>
                <th>Horas Nocturnas</th>
                <th>Horas Dominicales</th>
                <th>Salario Base</th>
                <th>Bonificaciones</th>
                <th>Deducciones</th>
                <th>Salario Neto</th>
                <th>Costo Empresa</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="nominasTableBody">
              <!-- Las nóminas se cargarán aquí dinámicamente -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="axyra-pagination">
          <button class="axyra-btn axyra-btn-ghost" onclick="cambiarPagina(-1)">
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span id="paginaInfo">Página 1 de 1</span>
          <button class="axyra-btn axyra-btn-ghost" onclick="cambiarPagina(1)">
            Siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </main>

    <!-- Modal Generar Nómina -->
    <div id="modalGenerarNomina" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button class="modal-close" onclick="cerrarModal('modalGenerarNomina')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Generar Nómina</h3>
          <p>Selecciona los parámetros para generar la nómina</p>
        </div>
        <div class="modal-body">
          <form id="formNomina" onsubmit="generarNomina(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="empleadoNomina">Empleado *</label>
                <select id="empleadoNomina" class="form-input" required>
                  <option value="">Seleccionar empleado</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mesNomina">Mes *</label>
                <select id="mesNomina" class="form-input" required>
                  <option value="">Seleccionar mes</option>
                  <option value="1">Enero</option>
                  <option value="2">Febrero</option>
                  <option value="3">Marzo</option>
                  <option value="4">Abril</option>
                  <option value="5">Mayo</option>
                  <option value="6">Junio</option>
                  <option value="7">Julio</option>
                  <option value="8">Agosto</option>
                  <option value="9">Septiembre</option>
                  <option value="10">Octubre</option>
                  <option value="11">Noviembre</option>
                  <option value="12">Diciembre</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="anioNomina">Año *</label>
                <select id="anioNomina" class="form-input" required>
                  <option value="">Seleccionar año</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tipoNomina">Tipo de Nómina</label>
                <select id="tipoNomina" class="form-input">
                  <option value="mensual">Mensual</option>
                  <option value="quincenal">Quincenal</option>
                  <option value="semanal">Semanal</option>
                </select>
              </div>
            </div>

            <div id="resumenNomina" class="resumen-nomina" style="display: none">
              <h4>Resumen de la Nómina</h4>
              <div id="detallesNomina"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalGenerarNomina')">Cancelar</button>
          <button class="btn btn-primary" onclick="generarNomina()">Generar Nómina</button>
        </div>
      </div>
    </div>

    <!-- Modal Configuración de Nómina -->
    <div id="modalConfiguracionNomina" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button class="modal-close" onclick="cerrarModal('modalConfiguracionNomina')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Configuración de Nómina</h3>
          <p>Configura los parámetros del sistema de nómina</p>
        </div>
        <div class="modal-body">
          <form id="formConfiguracionNomina">
            <div class="form-group">
              <label for="salarioMinimo">Salario Mínimo Legal Vigente</label>
              <input type="number" id="salarioMinimo" class="form-input" min="0" step="1000" />
            </div>

            <div class="form-group">
              <label for="porcentajeCesantias">Porcentaje Cesantías (%)</label>
              <input type="number" id="porcentajeCesantias" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajePrima">Porcentaje Prima de Servicios (%)</label>
              <input type="number" id="porcentajePrima" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajeInteresesCesantias">Porcentaje Intereses sobre Cesantías (%)</label>
              <input type="number" id="porcentajeInteresesCesantias" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajeSalud">Porcentaje Salud (%)</label>
              <input type="number" id="porcentajeSalud" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajePension">Porcentaje Pensión (%)</label>
              <input type="number" id="porcentajePension" class="form-input" min="0" max="100" step="0.1" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalConfiguracionNomina')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarConfiguracionNomina()">Guardar Configuración</button>
        </div>
      </div>
    </div>

    <!-- Modal Reportes Avanzados -->
    <div id="modalReportesAvanzados" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-width: 800px">
        <button class="modal-close" onclick="cerrarModal('modalReportesAvanzados')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Reportes Avanzados de Nómina</h3>
          <p>Genera reportes detallados y análisis de costos laborales</p>
        </div>
        <div class="modal-body">
          <div class="reportes-grid">
            <div class="reporte-card" onclick="generarReporte('costosLaborales')">
              <div class="reporte-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="reporte-content">
                <h4>Reporte de Costos Laborales</h4>
                <p>Análisis detallado de costos por empleado y período</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('prestacionesSociales')">
              <div class="reporte-icon">
                <i class="fas fa-hand-holding-usd"></i>
              </div>
              <div class="reporte-content">
                <h4>Prestaciones Sociales</h4>
                <p>Resumen de cesantías, prima de servicios e intereses</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('horasTrabajadas')">
              <div class="reporte-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="reporte-content">
                <h4>Análisis de Horas</h4>
                <p>Estadísticas de horas normales, extras y especiales</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('comparativoSalarios')">
              <div class="reporte-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <div class="reporte-content">
                <h4>Comparativo de Salarios</h4>
                <p>Comparación de salarios por departamento y cargo</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('tendenciasSalariales')">
              <div class="reporte-icon">
                <i class="fas fa-trending-up"></i>
              </div>
              <div class="reporte-content">
                <h4>Tendencias Salariales</h4>
                <p>Evolución de salarios a lo largo del tiempo</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('resumenMensual')">
              <div class="reporte-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="reporte-content">
                <h4>Resumen Mensual</h4>
                <p>Resumen completo de nómina del mes</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalReportesAvanzados')">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modalConfirmacion" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalConfirmacionTitulo">Confirmar Acción</h3>
          <p id="modalConfirmacionMensaje">¿Estás seguro de que quieres realizar esta acción?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalConfirmacion')">Cancelar</button>
          <button class="btn btn-danger" id="btnConfirmarAccion">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Sistema de Notificaciones -->
    <div id="notificationContainer"></div>

    <script>
      // Variables globales
      let nominas = [];
      let empleados = [];
      let horas = [];
      let paginaActual = 1;
      const nominasPorPagina = 10;
      let currentUser = null;

      // Inicialización cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        inicializarNomina();
        configurarEventos();
      });

      // Función de inicialización
      async function inicializarNomina() {
        try {
          // Verificar autenticación
          await verificarAutenticacion();

          // Cargar datos
          await cargarDatos();

          // Llenar selects
          llenarSelects();

          // Renderizar tabla
          renderizarTablaNominas();

          console.log('✅ Módulo de nómina inicializado correctamente');
        } catch (error) {
          console.error('❌ Error inicializando nómina:', error);
          mostrarNotificacion('Error inicializando módulo de nómina', 'error');
        }
      }

      // Verificar autenticación
      async function verificarAutenticacion() {
        try {
          // Usar el sistema de autenticación si está disponible
          if (window.axyraAuth && window.axyraAuth.isAuthenticated) {
            currentUser = window.axyraAuth.currentUser;
            console.log('✅ Usuario autenticado con sistema AXYRA:', currentUser?.username);
            return;
          }

          // Fallback: verificar localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (!userData) {
            window.location.href = '../../login.html';
            return;
          }

          currentUser = JSON.parse(userData);
          console.log('✅ Usuario autenticado con localStorage:', currentUser.username);
        } catch (error) {
          console.error('❌ Error verificando autenticación:', error);
          window.location.href = '../../login.html';
        }
      }

      // Cargar datos desde localStorage
      async function cargarDatos() {
        try {
          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username || e.userId === currentUser?.email;
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return h.userId === currentUser?.username || h.userId === currentUser?.email;
            });
          }

          // Cargar nóminas
          const nominasData = localStorage.getItem('axyra_nominas');
          if (nominasData) {
            nominas = JSON.parse(nominasData);
            // Filtrar por usuario actual
            nominas = nominas.filter((n) => {
              if (!n.userId) return true; // Datos globales
              return n.userId === currentUser?.username || n.userId === currentUser?.email;
            });
          }

          console.log(
            `✅ Datos cargados: ${empleados.length} empleados, ${horas.length} horas, ${nominas.length} nóminas`
          );
          
          // Verificar si hay datos y mostrar notificación si no
          if (empleados.length === 0) {
            console.warn('⚠️ No hay empleados registrados para el usuario actual');
          }
          if (horas.length === 0) {
            console.warn('⚠️ No hay horas registradas para el usuario actual');
          }
          if (nominas.length === 0) {
            console.warn('⚠️ No hay nóminas generadas para el usuario actual');
          }
        } catch (error) {
          console.error('❌ Error cargando datos:', error);
        }
      }

      // Llenar selects
      function llenarSelects() {
        // Select de empleados
        const selectsEmpleados = ['empleadoNomina', 'filterEmpleado'];
        selectsEmpleados.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Seleccionar empleado</option>';
            empleados.forEach((empleado) => {
              const option = document.createElement('option');
              option.value = empleado.id;
              option.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
              select.appendChild(option);
            });
          }
        });

        // Select de años
        const anioActual = new Date().getFullYear();
        const selectAnio = document.getElementById('anioNomina');
        if (selectAnio) {
          selectAnio.innerHTML = '<option value="">Seleccionar año</option>';
          for (let anio = anioActual - 2; anio <= anioActual + 1; anio++) {
            const option = document.createElement('option');
            option.value = anio;
            option.textContent = anio;
            if (anio === anioActual) option.selected = true;
            selectAnio.appendChild(option);
          }
        }

        // Select de años para filtro
        const filterAnio = document.getElementById('filterAnio');
        if (filterAnio) {
          filterAnio.innerHTML = '<option value="">Todos los años</option>';
          for (let anio = anioActual - 2; anio <= anioActual + 1; anio++) {
            const option = document.createElement('option');
            option.value = anio;
            option.textContent = anio;
            filterAnio.appendChild(option);
          }
        }
      }

      // Configurar eventos
      function configurarEventos() {
        // Búsqueda
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', filtrarNominas);
        }

        // Filtros
        const filterEmpleado = document.getElementById('filterEmpleado');
        if (filterEmpleado) {
          filterEmpleado.addEventListener('change', filtrarNominas);
        }

        const filterMes = document.getElementById('filterMes');
        if (filterMes) {
          filterMes.addEventListener('change', filtrarNominas);
        }

        const filterAnio = document.getElementById('filterAnio');
        if (filterAnio) {
          filterAnio.addEventListener('change', filtrarNominas);
        }

        // Cambio de empleado en nómina
        const empleadoNomina = document.getElementById('empleadoNomina');
        if (empleadoNomina) {
          empleadoNomina.addEventListener('change', calcularResumenNomina);
        }

        // Cambio de mes en nómina
        const mesNomina = document.getElementById('mesNomina');
        if (mesNomina) {
          mesNomina.addEventListener('change', calcularResumenNomina);
        }

        // Cambio de año en nómina
        const anioNomina = document.getElementById('anioNomina');
        if (anioNomina) {
          anioNomina.addEventListener('change', calcularResumenNomina);
        }
      }

      // Renderizar tabla de nóminas
      function renderizarTablaNominas() {
        const tbody = document.getElementById('nominasTableBody');
        if (!tbody) return;

        const nominasFiltradas = filtrarNominasPorPagina();

        if (nominasFiltradas.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="10" class="text-center">
                <p style="text-align: center; color: #718096; font-style: italic;">
                  No hay nóminas generadas
                </p>
              </td>
            </tr>
          `;
          return;
        }

        let html = '';
        nominasFiltradas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);

          html += `
            <tr>
              <td>${nomina.id || 'N/A'}</td>
              <td>${empleado ? empleado.nombre : 'Empleado no encontrado'}</td>
              <td>${obtenerNombreMes(nomina.mes)} ${nomina.anio}</td>
              <td>${nomina.horas_trabajadas || 0} hrs</td>
              <td>${nomina.horas_extras || 0} hrs</td>
              <td>${nomina.horas_nocturnas || 0} hrs</td>
              <td>${nomina.horas_dominicales || 0} hrs</td>
              <td>${formatearMoneda(nomina.salario_base) || 'N/A'}</td>
              <td>${formatearMoneda(nomina.bonificaciones) || '$0'}</td>
              <td>${formatearMoneda(nomina.deducciones) || '$0'}</td>
              <td>${formatearMoneda(nomina.salario_neto) || 'N/A'}</td>
              <td>${formatearMoneda(nomina.costo_total_empresa) || 'N/A'}</td>
              <td>
                <span class="estado-badge estado-${nomina.estado?.toLowerCase() || 'generada'}">
                  ${nomina.estado || 'Generada'}
                </span>
              </td>
              <td>
                <div class="acciones-nomina">
                  <button class="btn-accion btn-ver" onclick="verNomina(${nomina.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-accion btn-eliminar" onclick="eliminarNomina(${nomina.id})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        });

        tbody.innerHTML = html;
        actualizarPaginacion();
        actualizarMetricasDashboard();
      }

      // Actualizar métricas del dashboard
      function actualizarMetricasDashboard() {
        try {
          // Total empleados
          const totalEmpleados = empleados.length;
          document.getElementById('totalEmpleados').textContent = totalEmpleados;

          // Total nóminas
          const totalNominas = nominas.length;
          document.getElementById('totalNominas').textContent = totalNominas;

          // Costo total empresa
          const costoTotalEmpresa = nominas.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0);
          document.getElementById('costoTotalEmpresa').textContent = formatearMoneda(costoTotalEmpresa);

          // Total horas trabajadas
          const totalHorasTrabajadas = nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0);
          document.getElementById('totalHorasTrabajadas').textContent = `${totalHorasTrabajadas.toFixed(2)} hrs`;

          // Promedio salario
          const promedioSalario =
            empleados.length > 0 ? empleados.reduce((sum, e) => sum + (e.salario || 0), 0) / empleados.length : 0;
          document.getElementById('promedioSalario').textContent = formatearMoneda(promedioSalario);

          // Nóminas este mes
          const mesActual = new Date().getMonth() + 1;
          const anioActual = new Date().getFullYear();
          const nominasEsteMes = nominas.filter((n) => n.mes === mesActual && n.anio === anioActual).length;
          document.getElementById('nominasEsteMes').textContent = nominasEsteMes;
        } catch (error) {
          console.error('❌ Error actualizando métricas:', error);
        }
      }

      // Filtrar nóminas
      function filtrarNominas() {
        const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
        const empleadoId = document.getElementById('filterEmpleado')?.value || '';
        const mes = document.getElementById('filterMes')?.value || '';
        const anio = document.getElementById('filterAnio')?.value || '';

        let nominasFiltradas = nominas.filter((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          const cumpleBusqueda = !searchTerm || empleado?.nombre?.toLowerCase().includes(searchTerm);

          const cumpleEmpleado = !empleadoId || nomina.empleado_id == empleadoId;
          const cumpleMes = !mes || nomina.mes == mes;
          const cumpleAnio = !anio || nomina.anio == anio;

          return cumpleBusqueda && cumpleEmpleado && cumpleMes && cumpleAnio;
        });

        // Actualizar paginación
        paginaActual = 1;
        renderizarTablaNominas();
      }

      // Filtrar nóminas por página
      function filtrarNominasPorPagina() {
        const startIndex = (paginaActual - 1) * nominasPorPagina;
        const endIndex = startIndex + nominasPorPagina;
        return nominas.slice(startIndex, endIndex);
      }

      // Actualizar paginación
      function actualizarPaginacion() {
        const totalPaginas = Math.ceil(nominas.length / nominasPorPagina);
        const paginaInfo = document.getElementById('paginaInfo');

        if (paginaInfo) {
          paginaInfo.textContent = `Página ${paginaActual} de ${totalPaginas}`;
        }
      }

      // Cambiar página
      function cambiarPagina(direccion) {
        const totalPaginas = Math.ceil(nominas.length / nominasPorPagina);

        if (direccion === -1 && paginaActual > 1) {
          paginaActual--;
        } else if (direccion === 1 && paginaActual < totalPaginas) {
          paginaActual++;
        }

        renderizarTablaNominas();
      }

      // Mostrar modal
      function mostrarModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'flex';

          // Limpiar formulario si es el modal de nómina
          if (modalId === 'modalGenerarNomina') {
            limpiarFormularioNomina();
          }

          // Cargar configuración si es el modal de configuración
          if (modalId === 'modalConfiguracionNomina') {
            cargarConfiguracionGuardada();
          }

          // Verificar que el modal esté por encima del header
          if (modal.style.zIndex !== '9999') {
            modal.style.zIndex = '9999';
          }
        }
      }

      // Cerrar modal
      function cerrarModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Limpiar formulario de nómina
      function limpiarFormularioNomina() {
        const form = document.getElementById('formNomina');
        if (form) {
          form.reset();
        }

        // Ocultar resumen
        const resumen = document.getElementById('resumenNomina');
        if (resumen) {
          resumen.style.display = 'none';
        }
      }

      // Calcular resumen de la nómina
      function calcularResumenNomina() {
        const empleadoId = document.getElementById('empleadoNomina')?.value;
        const mes = document.getElementById('mesNomina')?.value;
        const anio = document.getElementById('anioNomina')?.value;

        if (!empleadoId || !mes || !anio) {
          document.getElementById('resumenNomina').style.display = 'none';
          return;
        }

        const empleado = empleados.find((e) => e.id == empleadoId);
        if (!empleado) return;

        // Filtrar horas del empleado para el mes y año especificados
        const horasEmpleado = horas.filter((h) => {
          if (h.empleado_id != empleadoId) return false;

          const fechaHora = new Date(h.fecha);
          return fechaHora.getMonth() + 1 == mes && fechaHora.getFullYear() == anio;
        });

        if (horasEmpleado.length === 0) {
          document.getElementById('detallesNomina').innerHTML =
            '<p class="error">No hay horas registradas para este empleado en el período seleccionado</p>';
          document.getElementById('resumenNomina').style.display = 'block';
          return;
        }

        // Calcular totales de horas
        const totalHoras = horasEmpleado.reduce((sum, h) => sum + (h.horas_trabajadas || 0), 0);
        const horasExtras = horasEmpleado.reduce((sum, h) => sum + (h.horas_extras || 0), 0);
        const horasNocturnas = horasEmpleado.reduce((sum, h) => sum + (h.horas_nocturnas || 0), 0);
        const horasDominicales = horasEmpleado.reduce((sum, h) => sum + (h.horas_dominicales || 0), 0);

        // Salario base y cálculos
        const salarioBase = empleado.salario || 0;
        const salarioPorHora = empleado.tipo_contrato === 'Por Horas' ? salarioBase / 160 : salarioBase / 160;
        const salarioMensual = empleado.tipo_contrato === 'Por Horas' ? totalHoras * salarioPorHora : salarioBase;

        // Cálculo de horas extras (25% adicional)
        const valorHorasExtras = horasExtras * salarioPorHora * 1.25;

        // Cálculo de horas nocturnas (35% adicional)
        const valorHorasNocturnas = horasNocturnas * salarioPorHora * 1.35;

        // Cálculo de horas dominicales (75% adicional)
        const valorHorasDominicales = horasDominicales * salarioPorHora * 1.75;

        // Subtotal de salario
        const subtotalSalario = salarioMensual + valorHorasExtras + valorHorasNocturnas + valorHorasDominicales;

        // Bonificaciones (10% del salario base)
        const bonificaciones = salarioMensual * 0.1;

        // Cálculo de prestaciones sociales
        const cesantias = subtotalSalario * 0.0833; // 8.33% mensual
        const primaServicios = subtotalSalario * 0.0833; // 8.33% mensual
        const interesesCesantias = cesantias * 0.12; // 12% anual, 1% mensual

        // Cálculo de aportes del empleado
        const saludEmpleado = subtotalSalario * 0.04; // 4% salud
        const pensionEmpleado = subtotalSalario * 0.04; // 4% pensión

        // Cálculo de aportes del empleador
        const saludEmpleador = subtotalSalario * 0.085; // 8.5% salud
        const pensionEmpleador = subtotalSalario * 0.12; // 12% pensión
        const riesgosLaborales = subtotalSalario * 0.00522; // 0.522% ARL (promedio)

        // Total deducciones del empleado
        const deduccionesEmpleado = saludEmpleado + pensionEmpleado;

        // Total costos del empleador
        const costosEmpleador =
          cesantias + primaServicios + interesesCesantias + saludEmpleador + pensionEmpleador + riesgosLaborales;

        // Salario neto (lo que recibe el empleado)
        const salarioNeto = subtotalSalario + bonificaciones - deduccionesEmpleado;

        // Costo total para la empresa
        const costoTotalEmpresa = subtotalSalario + bonificaciones + costosEmpleador;

        document.getElementById('detallesNomina').innerHTML = `
          <div class="detalle-item">
            <strong>Empleado:</strong> ${empleado.nombre}
          </div>
          <div class="detalle-item">
            <strong>Período:</strong> ${obtenerNombreMes(mes)} ${anio}
          </div>
          <div class="detalle-item">
            <strong>Total horas normales:</strong> ${totalHoras.toFixed(2)} hrs
          </div>
          <div class="detalle-item">
            <strong>Horas extras:</strong> ${horasExtras.toFixed(2)} hrs (${formatearMoneda(valorHorasExtras)})
          </div>
          <div class="detalle-item">
            <strong>Horas nocturnas:</strong> ${horasNocturnas.toFixed(2)} hrs (${formatearMoneda(valorHorasNocturnas)})
          </div>
          <div class="detalle-item">
            <strong>Horas dominicales:</strong> ${horasDominicales.toFixed(2)} hrs (${formatearMoneda(
          valorHorasDominicales
        )})
          </div>
          <div class="detalle-item">
            <strong>Salario base:</strong> ${formatearMoneda(salarioMensual)}
          </div>
          <div class="detalle-item">
            <strong>Subtotal salario:</strong> ${formatearMoneda(subtotalSalario)}
          </div>
          <div class="detalle-item">
            <strong>Bonificaciones:</strong> ${formatearMoneda(bonificaciones)}
          </div>
          <div class="detalle-item">
            <strong>Deducciones empleado:</strong> ${formatearMoneda(deduccionesEmpleado)}
          </div>
          <div class="detalle-item total">
            <strong>Salario neto empleado:</strong> ${formatearMoneda(salarioNeto)}
          </div>
          <hr style="margin: 10px 0; border: 1px solid #e2e8f0;">
          <div class="detalle-item">
            <strong>Cesantías:</strong> ${formatearMoneda(cesantias)}
          </div>
          <div class="detalle-item">
            <strong>Prima de servicios:</strong> ${formatearMoneda(primaServicios)}
          </div>
          <div class="detalle-item">
            <strong>Intereses cesantías:</strong> ${formatearMoneda(interesesCesantias)}
          </div>
          <div class="detalle-item">
            <strong>Aportes empleador:</strong> ${formatearMoneda(saludEmpleador + pensionEmpleador + riesgosLaborales)}
          </div>
          <div class="detalle-item total-empleador">
            <strong>Costo total empresa:</strong> ${formatearMoneda(costoTotalEmpresa)}
          </div>
        `;

        document.getElementById('resumenNomina').style.display = 'block';
      }

      // Generar nómina
      function generarNomina(event) {
        if (event) {
          event.preventDefault();
        }

        try {
          // Validar campos requeridos
          const empleadoId = document.getElementById('empleadoNomina')?.value;
          const mes = document.getElementById('mesNomina')?.value;
          const anio = document.getElementById('anioNomina')?.value;

          if (!empleadoId || !mes || !anio) {
            mostrarNotificacion('Por favor completa todos los campos requeridos', 'error');
            return;
          }

          const empleado = empleados.find((e) => e.id == empleadoId);
          if (!empleado) {
            mostrarNotificacion('Empleado no encontrado', 'error');
            return;
          }

          // Filtrar horas del empleado para el mes y año especificados
          const horasEmpleado = horas.filter((h) => {
            if (h.empleado_id != empleadoId) return false;

            const fechaHora = new Date(h.fecha);
            return fechaHora.getMonth() + 1 == mes && fechaHora.getFullYear() == anio;
          });

          if (horasEmpleado.length === 0) {
            mostrarNotificacion('No hay horas registradas para este empleado en el período seleccionado', 'error');
            return;
          }

          // Calcular totales de horas
          const totalHoras = horasEmpleado.reduce((sum, h) => sum + (h.horas_trabajadas || 0), 0);
          const horasExtras = horasEmpleado.reduce((sum, h) => sum + (h.horas_extras || 0), 0);
          const horasNocturnas = horasEmpleado.reduce((sum, h) => sum + (h.horas_nocturnas || 0), 0);
          const horasDominicales = horasEmpleado.reduce((sum, h) => sum + (h.horas_dominicales || 0), 0);

          // Salario base y cálculos
          const salarioBase = empleado.salario || 0;
          const salarioPorHora = empleado.tipo_contrato === 'Por Horas' ? salarioBase / 160 : salarioBase / 160;
          const salarioMensual = empleado.tipo_contrato === 'Por Horas' ? totalHoras * salarioPorHora : salarioBase;

          // Cálculo de horas extras (25% adicional)
          const valorHorasExtras = horasExtras * salarioPorHora * 1.25;

          // Cálculo de horas nocturnas (35% adicional)
          const valorHorasNocturnas = horasNocturnas * salarioPorHora * 1.35;

          // Cálculo de horas dominicales (75% adicional)
          const valorHorasDominicales = horasDominicales * salarioPorHora * 1.75;

          // Subtotal de salario
          const subtotalSalario = salarioMensual + valorHorasExtras + valorHorasNocturnas + valorHorasDominicales;

          // Bonificaciones (10% del salario base)
          const bonificaciones = salarioMensual * 0.1;

          // Cálculo de prestaciones sociales
          const cesantias = subtotalSalario * 0.0833; // 8.33% mensual
          const primaServicios = subtotalSalario * 0.0833; // 8.33% mensual
          const interesesCesantias = cesantias * 0.12; // 12% anual, 1% mensual

          // Cálculo de aportes del empleado
          const saludEmpleado = subtotalSalario * 0.04; // 4% salud
          const pensionEmpleado = subtotalSalario * 0.04; // 4% pensión

          // Cálculo de aportes del empleador
          const saludEmpleador = subtotalSalario * 0.085; // 8.5% salud
          const pensionEmpleador = subtotalSalario * 0.12; // 12% pensión
          const riesgosLaborales = subtotalSalario * 0.00522; // 0.522% ARL (promedio)

          // Total deducciones del empleado
          const deduccionesEmpleado = saludEmpleado + pensionEmpleado;

          // Total costos del empleador
          const costosEmpleador =
            cesantias + primaServicios + interesesCesantias + saludEmpleador + pensionEmpleador + riesgosLaborales;

          // Salario neto (lo que recibe el empleado)
          const salarioNeto = subtotalSalario + bonificaciones - deduccionesEmpleado;

          // Costo total para la empresa
          const costoTotalEmpresa = subtotalSalario + bonificaciones + costosEmpleador;

          // Crear objeto nómina
          const nomina = {
            id: Date.now(),
            empleado_id: parseInt(empleadoId),
            mes: parseInt(mes),
            anio: parseInt(anio),
            tipo_nomina: document.getElementById('tipoNomina')?.value || 'mensual',
            horas_trabajadas: totalHoras,
            horas_extras: horasExtras,
            horas_nocturnas: horasNocturnas,
            horas_dominicales: horasDominicales,
            salario_base: salarioMensual,
            salario_por_hora: salarioPorHora,
            valor_horas_extras: valorHorasExtras,
            valor_horas_nocturnas: valorHorasNocturnas,
            valor_horas_dominicales: valorHorasDominicales,
            subtotal_salario: subtotalSalario,
            bonificaciones: bonificaciones,
            cesantias: cesantias,
            prima_servicios: primaServicios,
            intereses_cesantias: interesesCesantias,
            salud_empleado: saludEmpleado,
            pension_empleado: pensionEmpleado,
            deducciones: deduccionesEmpleado,
            salario_neto: salarioNeto,
            salud_empleador: saludEmpleador,
            pension_empleador: pensionEmpleador,
            riesgos_laborales: riesgosLaborales,
            costos_empleador: costosEmpleador,
            costo_total_empresa: costoTotalEmpresa,
            estado: 'Generada',
            fecha_generacion: new Date().toISOString(),
            userId: currentUser?.username || currentUser?.email || 'axyra',
          };

          // Agregar a la lista de nóminas
          nominas.push(nomina);

          // Guardar en localStorage
          localStorage.setItem('axyra_nominas', JSON.stringify(nominas));

          // Cerrar modal y actualizar tabla
          cerrarModal('modalGenerarNomina');
          renderizarTablaNominas();

          // Mostrar notificación de éxito
          mostrarNotificacion(
            `Nómina generada correctamente para ${empleado.nombre}. Salario neto: ${formatearMoneda(salarioNeto)}`,
            'success'
          );

          console.log('✅ Nómina generada:', nomina);
        } catch (error) {
          console.error('❌ Error generando nómina:', error);
          mostrarNotificacion('Error generando nómina: ' + error.message, 'error');
        }
      }

      // Ver nómina
      function verNomina(id) {
        const nomina = nominas.find((n) => n.id === id);
        if (!nomina) {
          mostrarNotificacion('Nómina no encontrada', 'error');
          return;
        }

        const empleado = empleados.find((e) => e.id === nomina.empleado_id);

        // Mostrar información de la nómina en una notificación
        const info = `
          <strong>Nómina #${nomina.id}</strong><br>
          <strong>Empleado:</strong> ${empleado ? empleado.nombre : 'No encontrado'}<br>
          <strong>Período:</strong> ${obtenerNombreMes(nomina.mes)} ${nomina.anio}<br>
          <strong>Tipo:</strong> ${nomina.tipo_nomina || 'Mensual'}<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>HORAS TRABAJADAS:</strong><br>
          • Normales: ${nomina.horas_trabajadas || 0} hrs<br>
          • Extras: ${nomina.horas_extras || 0} hrs (${formatearMoneda(nomina.valor_horas_extras || 0)})<br>
          • Nocturnas: ${nomina.horas_nocturnas || 0} hrs (${formatearMoneda(nomina.valor_horas_nocturnas || 0)})<br>
          • Dominicales: ${nomina.horas_dominicales || 0} hrs (${formatearMoneda(
          nomina.valor_horas_dominicales || 0
        )})<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>LIQUIDACIÓN:</strong><br>
          • Salario base: ${formatearMoneda(nomina.salario_base)}<br>
          • Subtotal salario: ${formatearMoneda(nomina.subtotal_salario || nomina.salario_base)}<br>
          • Bonificaciones: ${formatearMoneda(nomina.bonificaciones)}<br>
          • Deducciones empleado: ${formatearMoneda(nomina.deducciones)}<br>
          <strong>• Salario neto: ${formatearMoneda(nomina.salario_neto)}</strong><br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>PRESTACIONES SOCIALES:</strong><br>
          • Cesantías: ${formatearMoneda(nomina.cesantias)}<br>
          • Prima servicios: ${formatearMoneda(nomina.prima_servicios)}<br>
          • Intereses cesantías: ${formatearMoneda(nomina.intereses_cesantias)}<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>APORTES EMPLEADOR:</strong><br>
          • Salud: ${formatearMoneda(nomina.salud_empleador)}<br>
          • Pensión: ${formatearMoneda(nomina.pension_empleador)}<br>
          • Riesgos laborales: ${formatearMoneda(nomina.riesgos_laborales)}<br>
          <strong>• Costo total empresa: ${formatearMoneda(nomina.costo_total_empresa)}</strong><br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>Fecha generación:</strong> ${new Date(nomina.fecha_generacion).toLocaleDateString('es-ES')}
        `;

        mostrarNotificacion(info, 'info', 15000);
      }

      // Eliminar nómina
      function eliminarNomina(id) {
        const nomina = nominas.find((n) => n.id === id);
        if (!nomina) {
          mostrarNotificacion('Nómina no encontrada', 'error');
          return;
        }

        // Mostrar modal de confirmación
        document.getElementById('modalConfirmacionTitulo').textContent = 'Eliminar Nómina';
        document.getElementById(
          'modalConfirmacionMensaje'
        ).textContent = `¿Estás seguro de que quieres eliminar la nómina del ${obtenerNombreMes(nomina.mes)} ${
          nomina.anio
        }? Esta acción no se puede deshacer.`;

        // Configurar botón de confirmación
        const btnConfirmar = document.getElementById('btnConfirmarAccion');
        btnConfirmar.onclick = () => confirmarEliminarNomina(id);

        // Mostrar modal
        mostrarModal('modalConfirmacion');
      }

      // Confirmar eliminación de nómina
      function confirmarEliminarNomina(id) {
        try {
          // Filtrar nómina a eliminar
          nominas = nominas.filter((n) => n.id !== id);

          // Guardar en localStorage
          localStorage.setItem('axyra_nominas', JSON.stringify(nominas));

          // Cerrar modal y actualizar tabla
          cerrarModal('modalConfirmacion');
          renderizarTablaNominas();

          mostrarNotificacion('Nómina eliminada correctamente', 'success');
        } catch (error) {
          console.error('❌ Error eliminando nómina:', error);
          mostrarNotificacion('Error eliminando nómina: ' + error.message, 'error');
        }
      }

      // Guardar configuración de nómina
      function guardarConfiguracionNomina() {
        try {
          const configuracion = {
            salarioMinimo: parseFloat(document.getElementById('salarioMinimo')?.value || 0),
            porcentajeCesantias: parseFloat(document.getElementById('porcentajeCesantias')?.value || 0),
            porcentajePrima: parseFloat(document.getElementById('porcentajePrima')?.value || 0),
            porcentajeInteresesCesantias: parseFloat(
              document.getElementById('porcentajeInteresesCesantias')?.value || 0
            ),
            porcentajeSalud: parseFloat(document.getElementById('porcentajeSalud')?.value || 0),
            porcentajePension: parseFloat(document.getElementById('porcentajePension')?.value || 0),
            fecha_actualizacion: new Date().toISOString(),
          };

          // Guardar en localStorage
          localStorage.setItem('axyra_configuracion_nomina', JSON.stringify(configuracion));

          // Cerrar modal
          cerrarModal('modalConfiguracionNomina');

          // Mostrar notificación de éxito
          mostrarNotificacion('Configuración de nómina guardada correctamente', 'success');
        } catch (error) {
          console.error('❌ Error guardando configuración:', error);
          mostrarNotificacion('Error guardando configuración: ' + error.message, 'error');
        }
      }

      // Exportar nómina
      function exportarNomina() {
        try {
          if (nominas.length === 0) {
            mostrarNotificacion('No hay nóminas generadas para exportar', 'warning');
            return;
          }

          if (typeof window.axyraExcelExport !== 'undefined' && window.axyraExcelExport.exportarNomina) {
            window.axyraExcelExport.exportarNomina();
          } else {
            // Fallback: exportar manualmente con estilos básicos
            const data = [
              ['REPORTE DE NÓMINAS - Villa Venecia'],
              ['EMPRESA: Villa Venecia'],
              ['NIT: NIT Pendiente'],
              [`FECHA DE EXPORTACIÓN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
              [],
              ['ID', 'Empleado', 'Cédula', 'Período', 'Horas Normales', 'Horas Extras', 'Horas Nocturnas', 'Horas Dominicales', 'Salario Base', 'Bonificaciones', 'Deducciones', 'Salario Neto', 'Costo Empresa', 'Estado', 'Fecha Generación']
            ];

            nominas.forEach((n) => {
              const empleado = empleados.find((e) => e.id === n.empleado_id);
              data.push([
                n.id || 'N/A',
                empleado ? empleado.nombre : 'Empleado no encontrado',
                empleado ? empleado.cedula || 'N/A' : 'N/A',
                `${obtenerNombreMes(n.mes)} ${n.anio}`,
                (n.horas_trabajadas || 0).toLocaleString('es-CO'),
                (n.horas_extras || 0).toLocaleString('es-CO'),
                (n.horas_nocturnas || 0).toLocaleString('es-CO'),
                (n.horas_dominicales || 0).toLocaleString('es-CO'),
                formatearMoneda(n.salario_base),
                formatearMoneda(n.bonificaciones || 0),
                formatearMoneda(n.deducciones || 0),
                formatearMoneda(n.salario_neto),
                formatearMoneda(n.costo_total_empresa),
                n.estado || 'Generada',
                new Date(n.fecha_generacion).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })
              ]);
            });

            // Agregar totales
            data.push([]);
            data.push(['TOTALES', '', '', '', 
              nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_extras || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_nocturnas || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_dominicales || 0), 0).toLocaleString('es-CO'),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.salario_base || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.bonificaciones || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.deducciones || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.salario_neto || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0)),
              '', ''
            ]);

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Nóminas');

            // Ajustar ancho de columnas
            ws['!cols'] = [
              { width: 8 }, { width: 25 }, { width: 15 }, { width: 15 },
              { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 },
              { width: 18 }, { width: 18 }, { width: 18 }, { width: 18 },
              { width: 18 }, { width: 12 }, { width: 20 }
            ];

            const now = new Date();
            const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
            const fileName = `REPORTE_NOMINAS_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime.getHours().toString().padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            mostrarNotificacion('Nóminas exportadas correctamente con formato profesional', 'success');
          }
        } catch (error) {
          console.error('❌ Error exportando nóminas:', error);
          mostrarNotificacion('Error exportando nóminas: ' + error.message, 'error');
        }
      }

      // Generar comprobante PDF
      function generarComprobantePDF() {
        try {
          // Verificar si hay nóminas seleccionadas
          const nominasSeleccionadas = nominas.filter((n) => n.estado === 'Generada');

          if (nominasSeleccionadas.length === 0) {
            mostrarNotificacion('No hay nóminas generadas para crear comprobantes PDF', 'warning');
            return;
          }

          // Crear contenido del PDF
          const contenidoPDF = crearContenidoPDF(nominasSeleccionadas);

          // Generar PDF usando jsPDF
          if (typeof window.jspdf !== 'undefined') {
            generarPDFConJsPDF(contenidoPDF);
          } else {
            // Fallback: mostrar contenido en nueva ventana para imprimir
            mostrarContenidoParaImprimir(contenidoPDF);
          }

          mostrarNotificacion('Comprobantes PDF generados correctamente', 'success');
        } catch (error) {
          console.error('❌ Error generando PDF:', error);
          mostrarNotificacion('Error generando PDF: ' + error.message, 'error');
        }
      }

      // Crear contenido del PDF
      function crearContenidoPDF(nominas) {
        let contenido = '';

        nominas.forEach((nomina, index) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          contenido += `
            <div style="page-break-after: always; padding: 20px; font-family: Arial, sans-serif;">
              <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color: #667eea; margin: 0;">COMPROBANTE DE PAGO DE NÓMINA</h1>
                <h2 style="color: #764ba2; margin: 10px 0;">AXYRA - Sistema de Gestión</h2>
                <p style="margin: 5px 0;">Período: ${obtenerNombreMes(nomina.mes)} ${nomina.anio}</p>
                <p style="margin: 5px 0;">Fecha de generación: ${new Date(nomina.fecha_generacion).toLocaleDateString(
                  'es-ES'
                )}</p>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">INFORMACIÓN DEL EMPLEADO</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 30%;">Nombre:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.nombre}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Cédula:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.cedula || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Cargo:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.cargo || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tipo Contrato:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.tipo_contrato || 'N/A'}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">HORAS TRABAJADAS</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background-color: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Tipo de Hora</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Valor</th>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Normales</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_trabajadas || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.salario_base
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Extras</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_extras || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_extras || 0
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Nocturnas</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_nocturnas || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_nocturnas || 0
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Dominicales</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_dominicales || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_dominicales || 0
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">LIQUIDACIÓN DE NÓMINA</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background-color: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Concepto</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Valor</th>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Subtotal Salario</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.subtotal_salario || nomina.salario_base
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Bonificaciones</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.bonificaciones
                    )}</td>
                  </tr>
                  <tr style="background-color: #f1f3f4;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">Total Devengado</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                      (nomina.subtotal_salario || nomina.salario_base) + nomina.bonificaciones
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Salud (4%)</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-${formatearMoneda(
                      nomina.salud_empleado
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Pensión (4%)</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-${formatearMoneda(
                      nomina.pension_empleado
                    )}</td>
                  </tr>
                  <tr style="background-color: #f1f3f4;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">Total Deducciones</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">-${formatearMoneda(
                      nomina.deducciones
                    )}</td>
                  </tr>
                  <tr style="background-color: #e8f5e8; border: 2px solid #4caf50;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">SALARIO NETO A PAGAR</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 16px; color: #2e7d32;">${formatearMoneda(
                      nomina.salario_neto
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">PRESTACIONES SOCIALES</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 50%;">Cesantías (8.33%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.cesantias
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Prima de Servicios (8.33%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.prima_servicios
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Intereses sobre Cesantías (12%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.intereses_cesantias
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 2px solid #333;">
                <p style="margin: 5px 0; font-size: 14px;">Este documento es generado automáticamente por el sistema AXYRA</p>
                <p style="margin: 5px 0; font-size: 12px; color: #666;">ID de Nómina: ${nomina.id} | Fecha: ${new Date(
            nomina.fecha_generacion
          ).toLocaleDateString('es-ES')}</p>
              </div>
            </div>
          `;

          if (index < nominas.length - 1) {
            contenido += '<div style="page-break-after: always;"></div>';
          }
        });

        return contenido;
      }

      // Generar PDF con jsPDF
      function generarPDFConJsPDF(contenido) {
        // Esta función se implementaría si jsPDF estuviera disponible
        console.log('Generando PDF con jsPDF...');
        mostrarContenidoParaImprimir(contenido);
      }

      // Mostrar contenido para imprimir
      function mostrarContenidoParaImprimir(contenido) {
        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Comprobantes de Nómina - AXYRA</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                @media print {
                  body { padding: 0; }
                  .no-print { display: none; }
                }
              </style>
            </head>
            <body>
              <div class="no-print" style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h2>Comprobantes de Nómina - AXYRA</h2>
                <p>Presiona Ctrl+P para imprimir o guardar como PDF</p>
                <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  Imprimir / Guardar PDF
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                  Cerrar
                </button>
              </div>
              ${contenido}
            </body>
          </html>
        `);
        ventanaImpresion.document.close();
      }

      // Funciones auxiliares
      function formatearMoneda(amount) {
        if (!amount || amount === 0) return '$0';
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // Formatear número con separadores de miles
      function formatearNumero(numero) {
        if (!numero || numero === 0) return '0';
        return numero.toLocaleString('es-CO', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      }

      function obtenerNombreMes(mes) {
        const meses = [
          'Enero',
          'Febrero',
          'Marzo',
          'Abril',
          'Mayo',
          'Junio',
          'Julio',
          'Agosto',
          'Septiembre',
          'Octubre',
          'Noviembre',
          'Diciembre',
        ];
        return meses[mes - 1] || 'Mes inválido';
      }

      function logout() {
        try {
          // Usar el sistema de autenticación si está disponible
          if (window.axyraAuth && typeof window.axyraAuth.logout === 'function') {
            window.axyraAuth.logout();
          } else {
            // Fallback: limpiar localStorage manualmente
            localStorage.removeItem('axyra_isolated_user');
            localStorage.removeItem('axyra_firebase_user');
            window.location.href = '../../login.html';
          }
        } catch (error) {
          console.error('❌ Error en logout:', error);
          window.location.href = '../../login.html';
        }
      }

      // Sistema de notificaciones
      function mostrarNotificacion(mensaje, tipo = 'info', duracion = 5000) {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span class="notification-message">${mensaje}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

        container.appendChild(notification);

        // Auto-remover después del tiempo especificado
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, duracion);
      }

      // Cerrar modales al hacer click fuera
      window.onclick = function (event) {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      };

      // Generar reportes avanzados
      function generarReporte(tipoReporte) {
        try {
          let contenido = '';
          let titulo = '';

          switch (tipoReporte) {
            case 'costosLaborales':
              contenido = generarReporteCostosLaborales();
              titulo = 'Reporte de Costos Laborales';
              break;
            case 'prestacionesSociales':
              contenido = generarReportePrestacionesSociales();
              titulo = 'Reporte de Prestaciones Sociales';
              break;
            case 'horasTrabajadas':
              contenido = generarReporteHorasTrabajadas();
              titulo = 'Análisis de Horas Trabajadas';
              break;
            case 'comparativoSalarios':
              contenido = generarReporteComparativoSalarios();
              titulo = 'Comparativo de Salarios';
              break;
            case 'tendenciasSalariales':
              contenido = generarReporteTendenciasSalariales();
              titulo = 'Tendencias Salariales';
              break;
            case 'resumenMensual':
              contenido = generarReporteResumenMensual();
              titulo = 'Resumen Mensual de Nómina';
              break;
            default:
              mostrarNotificacion('Tipo de reporte no válido', 'error');
              return;
          }

          // Mostrar reporte en nueva ventana
          mostrarReporte(titulo, contenido);
        } catch (error) {
          console.error('❌ Error generando reporte:', error);
          mostrarNotificacion('Error generando reporte: ' + error.message, 'error');
        }
      }

      // Generar reporte de costos laborales
      function generarReporteCostosLaborales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">REPORTE DE COSTOS LABORALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Base</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Prestaciones</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Aportes Empleador</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        let totalCostos = 0;
        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const prestaciones =
            (nomina.cesantias || 0) + (nomina.prima_servicios || 0) + (nomina.intereses_cesantias || 0);
          const aportesEmpleador =
            (nomina.salud_empleador || 0) + (nomina.pension_empleador || 0) + (nomina.riesgos_laborales || 0);
          const costoTotal = (nomina.salario_base || 0) + prestaciones + aportesEmpleador;
          totalCostos += costoTotal;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.salario_base
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                prestaciones
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                aportesEmpleador
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                costoTotal
              )}</td>
            </tr>
          `;
        });

        contenido += `
            <tr style="background: #f8f9fa; font-weight: bold;">
              <td style="padding: 12px; border: 1px solid #ddd;">TOTAL</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce((sum, n) => sum + (n.salario_base || 0), 0)
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce(
                  (sum, n) => sum + (n.cesantias || 0) + (n.prima_servicios || 0) + (n.intereses_cesantias || 0),
                  0
                )
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce(
                  (sum, n) => sum + (n.salud_empleador || 0) + (n.pension_empleador || 0) + (n.riesgos_laborales || 0),
                  0
                )
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #dc2626; font-size: 16px;">${formatearMoneda(
                totalCostos
              )}</td>
            </tr>
          </tbody>
        </table>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
          <h3 style="color: #333; margin-top: 0;">Resumen Ejecutivo</h3>
          <p><strong>Total empleados:</strong> ${empleados.length}</p>
          <p><strong>Total nóminas generadas:</strong> ${nominas.length}</p>
          <p><strong>Costo total para la empresa:</strong> ${formatearMoneda(totalCostos)}</p>
          <p><strong>Costo promedio por empleado:</strong> ${formatearMoneda(
            empleados.length > 0 ? totalCostos / empleados.length : 0
          )}</p>
        </div>
        `;

        return contenido;
      }

      // Generar reporte de prestaciones sociales
      function generarReportePrestacionesSociales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">REPORTE DE PRESTACIONES SOCIALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Cesantías</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.cesantias || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">8.33% del salario mensual</p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Prima de Servicios</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.prima_servicios || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">8.33% del salario mensual</p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Intereses Cesantías</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.intereses_cesantias || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">12% anual sobre cesantías</p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cesantías</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Prima Servicios</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Intereses</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const total = (nomina.cesantias || 0) + (nomina.prima_servicios || 0) + (nomina.intereses_cesantias || 0);

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.cesantias
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.prima_servicios
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.intereses_cesantias
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                total
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte de horas trabajadas
      function generarReporteHorasTrabajadas() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">ANÁLISIS DE HORAS TRABAJADAS</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Horas Normales</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Horas Extras</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_extras || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Horas Nocturnas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_nocturnas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #fce4ec; padding: 20px; border-radius: 8px; border-left: 4px solid #e91e63;">
              <h3 style="color: #ad1457; margin-top: 0;">Horas Dominicales</h3>
              <p style="font-size: 24px; font-weight: bold; color: #ad1457; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_dominicales || 0), 0).toFixed(2)} hrs
              </p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Normales</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Extras</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Nocturnas</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Dominicales</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const total =
            (nomina.horas_trabajadas || 0) +
            (nomina.horas_extras || 0) +
            (nomina.horas_nocturnas || 0) +
            (nomina.horas_dominicales || 0);

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_trabajadas || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${nomina.horas_extras || 0}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${nomina.horas_nocturnas || 0}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_dominicales || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${total.toFixed(
                2
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte comparativo de salarios
      function generarReporteComparativoSalarios() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">COMPARATIVO DE SALARIOS</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cargo</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Base</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Neto</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Empresa</th>
              </tr>
            </thead>
            <tbody>
        `;

        // Agrupar por cargo
        const empleadosPorCargo = {};
        empleados.forEach((empleado) => {
          const cargo = empleado.cargo || 'Sin cargo';
          if (!empleadosPorCargo[cargo]) {
            empleadosPorCargo[cargo] = [];
          }
          empleadosPorCargo[cargo].push(empleado);
        });

        Object.keys(empleadosPorCargo).forEach((cargo) => {
          const empleadosCargo = empleadosPorCargo[cargo];

          // Agregar fila de encabezado del cargo
          contenido += `
            <tr style="background: #f8f9fa;">
              <td colspan="5" style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">
                ${cargo} (${empleadosCargo.length} empleado${empleadosCargo.length > 1 ? 's' : ''})
              </td>
            </tr>
          `;

          empleadosCargo.forEach((empleado) => {
            const nomina = nominas.find((n) => n.empleado_id === empleado.id);
            if (nomina) {
              contenido += `
                <tr>
                  <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
                  <td style="padding: 12px; border: 1px solid #ddd;">${cargo}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    empleado.salario
                  )}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    nomina.salario_neto
                  )}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    nomina.costo_total_empresa
                  )}</td>
                </tr>
              `;
            }
          });
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte de tendencias salariales
      function generarReporteTendenciasSalariales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">TENDENCIAS SALARIALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="color: #333; margin-top: 0;">Estadísticas Generales</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
              <div>
                <p style="margin: 5px 0;"><strong>Salario promedio:</strong> ${formatearMoneda(
                  empleados.length > 0 ? empleados.reduce((sum, e) => sum + (e.salario || 0), 0) / empleados.length : 0
                )}</p>
                <p style="margin: 5px 0;"><strong>Salario mínimo:</strong> ${formatearMoneda(
                  Math.min(...empleados.map((e) => e.salario || 0))
                )}</p>
                <p style="margin: 5px 0;"><strong>Salario máximo:</strong> ${formatearMoneda(
                  Math.max(...empleados.map((e) => e.salario || 0))
                )}</p>
              </div>
              <div>
                <p style="margin: 5px 0;"><strong>Total empleados:</strong> ${empleados.length}</p>
                <p style="margin: 5px 0;"><strong>Empleados con salario > $2M:</strong> ${
                  empleados.filter((e) => (e.salario || 0) > 2000000).length
                }</p>
                <p style="margin: 5px 0;"><strong>Empleados con salario < $1M:</strong> ${
                  empleados.filter((e) => (e.salario || 0) < 1000000).length
                }</p>
              </div>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Rango Salarial</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cantidad Empleados</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Porcentaje</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total Salarios</th>
              </tr>
            </thead>
            <tbody>
        `;

        const rangos = [
          { min: 0, max: 1000000, label: 'Menos de $1M' },
          { min: 1000000, max: 2000000, label: '$1M - $2M' },
          { min: 2000000, max: 3000000, label: '$2M - $3M' },
          { min: 3000000, max: 5000000, label: '$3M - $5M' },
          { min: 5000000, max: Infinity, label: 'Más de $5M' },
        ];

        rangos.forEach((rango) => {
          const empleadosEnRango = empleados.filter((e) => {
            const salario = e.salario || 0;
            return salario >= rango.min && salario < rango.max;
          });

          const totalSalarios = empleadosEnRango.reduce((sum, e) => sum + (e.salario || 0), 0);
          const porcentaje = empleados.length > 0 ? ((empleadosEnRango.length / empleados.length) * 100).toFixed(1) : 0;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${rango.label}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${empleadosEnRango.length}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${porcentaje}%</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                totalSalarios
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte resumen mensual
      function generarReporteResumenMensual() {
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        const nominasMes = nominas.filter((n) => n.mes === mesActual && n.anio === anioActual);

        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">RESUMEN MENSUAL DE NÓMINA</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${obtenerNombreMes(
            mesActual
          )} ${anioActual}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Total Nóminas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${nominasMes.length}
              </p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Total Horas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${nominasMes.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Total Salarios</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${formatearMoneda(nominasMes.reduce((sum, n) => sum + (n.salario_neto || 0), 0))}
              </p>
            </div>
            
            <div style="background: #fce4ec; padding: 20px; border-radius: 8px; border-left: 4px solid #e91e63;">
              <h3 style="color: #ad1457; margin-top: 0;">Costo Empresa</h3>
              <p style="font-size: 24px; font-weight: bold; color: #ad1457; margin: 10px 0;">
                ${formatearMoneda(nominasMes.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0))}
              </p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Horas</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Neto</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Empresa</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Estado</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominasMes.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_trabajadas || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.salario_neto
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.costo_total_empresa
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                <span class="estado-badge estado-${nomina.estado?.toLowerCase() || 'generada'}">
                  ${nomina.estado || 'Generada'}
                </span>
              </td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Mostrar reporte
      function mostrarReporte(titulo, contenido) {
        const ventanaReporte = window.open('', '_blank');
        ventanaReporte.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>${titulo} - AXYRA</title>
              <style>
                body { 
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                  margin: 0; 
                  padding: 20px; 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                }
                .reporte-container { 
                  max-width: 1200px; 
                  margin: 0 auto; 
                  background: white; 
                  padding: 30px; 
                  border-radius: 16px; 
                  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                  position: relative;
                  overflow: hidden;
                }
                .reporte-container::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  height: 4px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                .no-print { 
                  text-align: center; 
                  margin-bottom: 30px; 
                  padding: 25px; 
                  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                  border-radius: 12px;
                  border: 1px solid #e2e8f0;
                }
                .no-print h2 {
                  color: #1e3a8a;
                  margin: 0 0 15px 0;
                  font-size: 1.8rem;
                  font-weight: 600;
                }
                .no-print p {
                  color: #64748b;
                  margin: 0 0 20px 0;
                  font-size: 1rem;
                }
                .btn { 
                  padding: 12px 24px; 
                  margin: 8px; 
                  border: none; 
                  border-radius: 8px; 
                  cursor: pointer; 
                  font-size: 14px; 
                  font-weight: 600;
                  transition: all 0.3s ease;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                }
                .btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                }
                .btn-primary { 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                  color: white; 
                }
                .btn-secondary { 
                  background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
                  color: white; 
                }
                .btn-success {
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  color: white;
                }
                .reporte-content {
                  background: white;
                  border-radius: 8px;
                  overflow: hidden;
                }
                .reporte-content h2 {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 20px;
                  margin: 0;
                  text-align: center;
                  font-size: 1.5rem;
                  font-weight: 600;
                }
                .reporte-content table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 20px 0;
                }
                .reporte-content th {
                  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                  color: #1e3a8a;
                  padding: 15px;
                  text-align: left;
                  font-weight: 600;
                  border-bottom: 2px solid #cbd5e1;
                }
                .reporte-content td {
                  padding: 12px 15px;
                  border-bottom: 1px solid #e2e8f0;
                }
                .reporte-content tr:nth-child(even) {
                  background: #f8fafc;
                }
                .reporte-content tr:hover {
                  background: #f1f5f9;
                }
                @media print {
                  body { 
                    background: white; 
                    padding: 0;
                  }
                  .no-print { display: none; }
                  .reporte-container { 
                    box-shadow: none; 
                    padding: 0; 
                    border-radius: 0;
                  }
                  .reporte-container::before {
                    display: none;
                  }
                }
                @media (max-width: 768px) {
                  body { padding: 10px; }
                  .reporte-container { padding: 20px; }
                  .no-print { padding: 20px; }
                  .btn { 
                    width: 100%; 
                    margin: 5px 0; 
                  }
                }
              </style>
            </head>
            <body>
              <div class="reporte-container">
                <div class="no-print">
                  <h2>${titulo}</h2>
                  <p>📊 Reporte generado automáticamente por el sistema AXYRA</p>
                  <p>💡 Presiona Ctrl+P para imprimir o guardar como PDF</p>
                  <button class="btn btn-primary" onclick="window.print()">
                    🖨️ Imprimir / Guardar PDF
                  </button>
                  <button class="btn btn-success" onclick="exportarReporteExcel()">
                    📊 Exportar a Excel
                  </button>
                  <button class="btn btn-secondary" onclick="window.close()">
                    ❌ Cerrar
                  </button>
                </div>
                <div class="reporte-content">
                  ${contenido}
                </div>
              </div>
              <script>
                function exportarReporteExcel() {
                  // Función para exportar a Excel (implementar si es necesario)
                  alert('Función de exportación a Excel en desarrollo');
                }
              </script>
            </body>
          </html>
        `);
        ventanaReporte.document.close();
      }

      // Cargar configuración guardada
      function cargarConfiguracionGuardada() {
        try {
          const configuracion = localStorage.getItem('axyra_configuracion_nomina');
          if (configuracion) {
            const config = JSON.parse(configuracion);

            // Llenar campos del formulario
            if (document.getElementById('salarioMinimo')) {
              document.getElementById('salarioMinimo').value = config.salarioMinimo || '';
            }
            if (document.getElementById('porcentajeCesantias')) {
              document.getElementById('porcentajeCesantias').value = config.porcentajeCesantias || '';
            }
            if (document.getElementById('porcentajePrima')) {
              document.getElementById('porcentajePrima').value = config.porcentajePrima || '';
            }
            if (document.getElementById('porcentajeInteresesCesantias')) {
              document.getElementById('porcentajeInteresesCesantias').value = config.porcentajeInteresesCesantias || '';
            }
            if (document.getElementById('porcentajeSalud')) {
              document.getElementById('porcentajeSalud').value = config.porcentajeSalud || '';
            }
            if (document.getElementById('porcentajePension')) {
              document.getElementById('porcentajePension').value = config.porcentajePension || '';
            }
          }
        } catch (error) {
          console.error('❌ Error cargando configuración:', error);
        }
      }
    </script>
  </body>
</html>
