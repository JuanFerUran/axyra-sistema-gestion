<!-- frontend/cuadre_caja.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Cuadre de Caja</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../../static/work-areas-config.js"></script>
    <script src="../../static/cash-reconciliation-export.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Cuadre de Caja</div>
          </div>
        </div>
        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link"> <i class="fas fa-home"></i> Inicio </a>
          <a href="../dashboard/dashboard.html" class="axyra-nav-link">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> Nómina
          </a>
          <a href="cuadre_caja.html" class="axyra-nav-link active">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuración
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Cuadre de Caja</h1>
          <p class="axyra-page-subtitle">Registro de ingresos por factura individual y control de caja</p>
        </div>

        <!-- Registrar Nueva Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Registrar Nueva Factura</h3>
              <p class="axyra-card-subtitle">Ingresa los datos de la factura</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formFactura" class="axyra-form">
              <div class="axyra-form-grid">
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Fecha</label>
                  <input type="date" id="fecha" class="axyra-form-input" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Encargado</label>
                  <div class="axyra-form-select-container">
                    <select id="encargado" class="axyra-form-select" required onchange="manejarCambioEncargado()">
                      <option value="">Seleccionar encargado</option>
                      <option value="JULIO CASTAÑO">JULIO CASTAÑO</option>
                      <option value="MARIA GONZALEZ">MARIA GONZALEZ</option>
                      <option value="CARLOS RODRIGUEZ">CARLOS RODRIGUEZ</option>
                      <option value="ANA MARTINEZ">ANA MARTINEZ</option>
                      <option value="LUIS PEREZ">LUIS PEREZ</option>
                      <option value="otro">Otro (escribir)</option>
                    </select>
                    <input
                      type="text"
                      id="encargadoOtro"
                      class="axyra-form-input"
                      placeholder="Escribir nombre del encargado"
                      style="display: none; margin-top: 8px"
                    />
                  </div>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Cédula del Encargado</label>
                  <input
                    type="text"
                    id="cedulaEncargado"
                    class="axyra-form-input"
                    placeholder="Ej: 12345678"
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Número de Factura</label>
                  <input type="text" id="numeroFactura" class="axyra-form-input" placeholder="Ej: 3945" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Área</label>
                  <select id="area" class="axyra-form-select" required>
                    <option value="">Seleccionar área</option>
                    <option value="BAR">BAR</option>
                    <option value="RESTAURANTE">RESTAURANTE</option>
                    <option value="RECEPCIÓN">RECEPCIÓN</option>
                    <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                    <option value="ADMINISTRACIÓN">ADMINISTRACIÓN</option>
                    <option value="OTRO">OTRO</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Monto</label>
                  <input type="number" id="monto" class="axyra-form-input" placeholder="0" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Método de Pago</label>
                  <select id="metodoPago" class="axyra-form-select" required>
                    <option value="">Seleccionar método</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Descripción</label>
                  <input
                    type="text"
                    id="descripcion"
                    class="axyra-form-input"
                    placeholder="Ej: Cocteles, Comida, etc."
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Estado</label>
                  <select id="estado" class="axyra-form-select" required>
                    <option value="">Seleccionar estado</option>
                    <option value="Pagada">Pagada</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Cancelada">Cancelada</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Link de Factura (Opcional)</label>
                  <input
                    type="url"
                    id="linkFactura"
                    class="axyra-form-input"
                    placeholder="https://ejemplo.com/factura"
                  />
                </div>
              </div>
              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-save"></i> Registrar Factura
                </button>
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="limpiarFormulario()">
                  <i class="fas fa-eraser"></i> Limpiar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Resumen del Día -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen del Día</h3>
              <p class="axyra-card-subtitle">Total de ingresos y facturas del día</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-caja-summary">
              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalFacturas">0</div>
                  <div class="axyra-summary-label">Total Facturas</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalIngresos">$0</div>
                  <div class="axyra-summary-label">Total Ingresos</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalEfectivo">$0</div>
                  <div class="axyra-summary-label">Efectivo</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-university"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalTransferencias">$0</div>
                  <div class="axyra-summary-label">Transferencias</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalDatafono">$0</div>
                  <div class="axyra-summary-label">Datafono</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-qrcode"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalQR">$0</div>
                  <div class="axyra-summary-label">QR</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-money-check"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalCheque">$0</div>
                  <div class="axyra-summary-label">Cheque</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalOtros">$0</div>
                  <div class="axyra-summary-label">Otros</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Última Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Última Factura</h3>
              <p class="axyra-card-subtitle">Información de la última factura registrada</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-ultima-factura-container">
              <div class="axyra-ultima-factura-info">
                <div class="axyra-ultima-factura-monto" id="ultimaFactura">$0</div>
                <div class="axyra-ultima-factura-details" id="ultimaFacturaInfo">No hay facturas registradas</div>
                <div class="axyra-ultima-factura-time" id="ultimaFacturaTime"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historial de Facturas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de Facturas</h3>
              <p class="axyra-card-subtitle">Todas las facturas registradas</p>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input
                type="text"
                id="searchFacturas"
                class="axyra-form-input"
                placeholder="Buscar por número o encargado..."
              />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <div class="axyra-date-filters">
                <input type="date" id="filterFechaDesde" class="axyra-form-input" placeholder="Desde" />
                <input type="date" id="filterFechaHasta" class="axyra-form-input" placeholder="Hasta" />
              </div>
              <select id="filterFechaFacturas" class="axyra-form-select">
                <option value="">Filtros rápidos</option>
                <option value="hoy">Hoy</option>
                <option value="ayer">Ayer</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="mesAnterior">Mes anterior</option>
                <option value="trimestre">Este trimestre</option>
                <option value="año">Este año</option>
              </select>
              <select id="filterAreaFacturas" class="axyra-form-select">
                <option value="">Todas las áreas</option>
                <option value="Administración">Administración</option>
                <option value="Ventas">Ventas</option>
                <option value="Producción">Producción</option>
                <option value="Tecnología">Tecnología</option>
              </select>
              <select id="filterMetodoPago" class="axyra-form-select">
                <option value="">Todos los métodos</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="datafono">Datafono</option>
                <option value="qr">QR</option>
                <option value="cheque">Cheque</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="aplicarFiltrosFacturas()">
              <i class="fas fa-filter"></i> Aplicar Filtros
            </button>
            <button class="axyra-btn axyra-btn-secondary" onclick="limpiarFiltrosFacturas()">
              <i class="fas fa-times"></i> Limpiar
            </button>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarFacturas()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-card-content">
            <div class="axyra-actions-bar">
              <button class="axyra-btn axyra-btn-success" onclick="exportarCuadreCaja()">
                <i class="fas fa-file-excel"></i> Exportar Cuadre de Caja
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="cargarResumen()">
                <i class="fas fa-sync-alt"></i> Actualizar Resumen
              </button>
              <button class="axyra-btn axyra-btn-warning" onclick="limpiarHistorial()">
                <i class="fas fa-trash"></i> Limpiar Historial
              </button>
            </div>

            <div class="axyra-table-container">
              <table class="axyra-table" id="facturasTable">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Número</th>
                    <th>Encargado</th>
                    <th>Área</th>
                    <th>Monto</th>
                    <th>Método de Pago</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="facturasTableBody">
                  <!-- Las facturas se cargarán dinámicamente -->
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            <div class="axyra-pagination">
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(-1)">
                <i class="fas fa-chevron-left"></i> Anterior
              </button>
              <span id="paginaFacturasInfo">Página 1 de 1</span>
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(1)">
                Siguiente <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="axyra-footer">
      <div class="axyra-container">
        <div class="axyra-footer-content">
          <p>&copy; 2025 AXYRA. Sistema de Gestión Empresarial.</p>
        </div>
      </div>
    </footer>

    <script>
      // Verificar autenticación
      async function checkAuth() {
        try {
          console.log('🔐 Verificando autenticación en cuadre de caja...');

          // Verificar sesión usando Firebase
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            const currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('✅ Usuario autenticado con Firebase en cuadre de caja:', currentUser.email);
            return true;
          }

          // Verificar sesión usando localStorage como fallback
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log(
                  '✅ Usuario autenticado con localStorage en cuadre de caja:',
                  userData.username || userData.email
                );
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesión de localStorage:', error);
            }
          }

          // No hay sesión activa
          console.log('⚠️ No hay sesión activa en cuadre de caja - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('❌ Error al verificar sesión en cuadre de caja:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Cerrar sesión - SISTEMA AISLADO
      function logout() {
        console.log('🔄 Cerrando sesión desde cuadre de caja...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('✅ Sesión cerrada desde cuadre de caja');
        window.location.href = '../../login.html';
      }

      // Variables globales
      let facturas = [];
      let empleados = [];
      let monedaActual = 'COP';

      // Inicialización
      window.addEventListener('load', async () => {
        try {
          console.log('🚀 AXYRA Cuadre de Caja inicializando...');

          // Verificar autenticación
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('✅ Usuario autenticado, cargando cuadre de caja...');

            // Cargar facturas
            await cargarFacturas();

            // Cargar resumen y configuración
            cargarResumen();
            cargarConfiguracion();

            console.log('✅ Módulo de cuadre de caja cargado correctamente');
          } else {
            console.log('❌ Usuario no autenticado, mostrando mensaje...');
            // NO redirigir automáticamente
          }
        } catch (error) {
          console.error('❌ Error inicializando módulo de cuadre de caja:', error);
          // NO redirigir automáticamente
        }
      });

      // Cargar facturas desde Firebase o localStorage
      async function cargarFacturas() {
        try {
          console.log('📊 Cargando facturas...');

          // Obtener usuario actual - SISTEMA AISLADO
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
            console.log(
              '✅ Usuario actual en cuadre de caja (sistema aislado):',
              currentUser.username || currentUser.email
            );
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
              console.log(
                '✅ Usuario actual en cuadre de caja (localStorage):',
                currentUser.username || currentUser.email
              );
            }
          }

          if (!currentUser) {
            console.log('⚠️ No hay usuario autenticado en cuadre de caja');
            facturas = [];
            mostrarFacturas();
            return;
          }

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('🔥 Intentando cargar facturas desde Firebase...');
              const facturasSnapshot = await firebase.firestore
                .collection('facturas')
                .where('userId', '==', currentUser.id)
                .get();

              if (!facturasSnapshot.empty) {
                facturas = [];
                facturasSnapshot.forEach((doc) => {
                  facturas.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`✅ Facturas cargadas desde Firebase: ${facturas.length}`);
              } else {
                console.log('ℹ️ No hay facturas en Firebase para este usuario');
                facturas = [];
              }
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando desde Firebase, usando localStorage:', firebaseError.message);
              // Cargar desde localStorage como fallback
              facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

              // Filtrar facturas por usuario actual
              if (currentUser.username || currentUser.email) {
                const userId = currentUser.username || currentUser.email;
                const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
                console.log(
                  `✅ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
                );
                facturas = facturasFiltradas;
              }
            }
          } else {
            // Firebase no disponible, usar localStorage
            console.log('💾 Cargando facturas desde localStorage...');
            facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

            // Filtrar facturas por usuario actual
            if (currentUser.username || currentUser.email) {
              const userId = currentUser.username || currentUser.email;
              const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
              console.log(
                `✅ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
              );
              facturas = facturasFiltradas;
            }
          }

          mostrarFacturas();
        } catch (error) {
          console.error('❌ Error cargando facturas:', error);
          facturas = [];
          mostrarFacturas();
        }
      }

      // Mostrar facturas en la tabla
      function mostrarFacturas() {
        const tbody = document.getElementById('facturasTableBody');
        if (facturas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="axyra-text-center">No hay facturas registradas</td></tr>';
          return;
        }

        tbody.innerHTML = facturas
          .map(
            (factura) => `
          <tr>
            <td>${formatearFecha(factura.fecha)}</td>
            <td>${factura.numero}</td>
            <td>${factura.encargado}</td>
            <td>${factura.area}</td>
            <td>${formatearMoneda(factura.monto)}</td>
            <td>${factura.metodoPago || '-'}</td>
            <td>${factura.descripcion || '-'}</td>
            <td>
              <button class="axyra-btn axyra-btn-danger axyra-btn-small" onclick="eliminarFactura('${factura.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `
          )
          .join('');
      }

      // Formatear fecha
      function formatearFecha(fecha) {
        return new Date(fecha).toLocaleDateString('es-CO');
      }

      // Función para formatear moneda sin decimales
      function formatearMoneda(valor) {
        if (valor === null || valor === undefined) return '$0';
        const numero = parseFloat(valor);
        if (isNaN(numero)) return '$0';

        // Usar separadores de miles con formato colombiano
        return (
          '$' +
          numero.toLocaleString('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          })
        );
      }

      // Función para formatear moneda con separadores de miles
      function formatearMonedaConSeparadores(valor) {
        if (typeof valor === 'number') {
          return valor.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          });
        }
        return valor;
      }

      // Cargar resumen del día
      function cargarResumen() {
        try {
          const fechaHoy = new Date().toISOString().split('T')[0];
          const facturasHoy = facturas.filter((f) => f.fecha === fechaHoy);

          // Calcular totales
          const totalFacturas = facturasHoy.length;
          const totalIngresos = facturasHoy.reduce((total, f) => total + parseFloat(f.monto), 0);

          // Calcular por método de pago
          const efectivo = facturasHoy
            .filter((f) => f.metodoPago === 'efectivo')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const transferencia = facturasHoy
            .filter((f) => f.metodoPago === 'transferencia')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const datafono = facturasHoy
            .filter((f) => f.metodoPago === 'datafono')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const qr = facturasHoy
            .filter((f) => f.metodoPago === 'qr')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const cheque = facturasHoy
            .filter((f) => f.metodoPago === 'cheque')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const otros = facturasHoy
            .filter((f) => !['efectivo', 'transferencia', 'datafono', 'qr', 'cheque'].includes(f.metodoPago))
            .reduce((total, f) => total + parseFloat(f.monto), 0);

          // Actualizar resumen
          document.getElementById('totalFacturas').textContent = totalFacturas;
          document.getElementById('totalIngresos').textContent = formatearMoneda(totalIngresos);
          document.getElementById('totalEfectivo').textContent = formatearMoneda(efectivo);
          document.getElementById('totalTransferencias').textContent = formatearMoneda(transferencia);

          // Actualizar métodos de pago adicionales si existen los elementos
          const totalDatafonoElement = document.getElementById('totalDatafono');
          const totalQRElement = document.getElementById('totalQR');
          const totalChequeElement = document.getElementById('totalCheque');
          const totalOtrosElement = document.getElementById('totalOtros');

          if (totalDatafonoElement) totalDatafonoElement.textContent = formatearMoneda(datafono);
          if (totalQRElement) totalQRElement.textContent = formatearMoneda(qr);
          if (totalChequeElement) totalChequeElement.textContent = formatearMoneda(cheque);
          if (totalOtrosElement) totalOtrosElement.textContent = formatearMoneda(otros);

          // Mostrar última factura con información completa
          if (facturasHoy.length > 0) {
            const ultimaFactura = facturasHoy[facturasHoy.length - 1];
            document.getElementById('ultimaFactura').textContent = formatearMoneda(ultimaFactura.monto);
            document.getElementById('ultimaFacturaInfo').textContent = `#${ultimaFactura.numero} - ${
              ultimaFactura.encargado
            } - ${ultimaFactura.metodoPago.toUpperCase()}`;

            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              const fechaFactura = new Date(ultimaFactura.fecha);
              // Formatear hora en zona horaria de Colombia
              const horaColombia = fechaFactura.toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'America/Bogota',
              });
              ultimaFacturaTimeElement.textContent = `Registrada a las ${horaColombia}`;
            }
          } else {
            document.getElementById('ultimaFactura').textContent = formatearMoneda(0);
            document.getElementById('ultimaFacturaInfo').textContent = 'No hay facturas hoy';
            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              ultimaFacturaTimeElement.textContent = '';
            }
          }

          console.log('✅ Resumen del día actualizado');
        } catch (error) {
          console.error('❌ Error cargando resumen:', error);
        }
      }

      // Cambiar moneda
      function cambiarMoneda(moneda) {
        document.querySelectorAll('.axyra-currency-option').forEach((option) => {
          option.classList.remove('active');
        });

        // Encontrar la opción seleccionada y marcarla como activa
        const opcionSeleccionada = document.querySelector(`.axyra-currency-option[onclick*="${moneda}"]`);
        if (opcionSeleccionada) {
          opcionSeleccionada.classList.add('active');
        }

        monedaActual = moneda;
        localStorage.setItem('axyra_moneda', moneda);

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje(`✅ Moneda cambiada a ${moneda}`, 'success');
      }

      // Función para actualizar inmediatamente la última factura
      function actualizarUltimaFactura(factura) {
        try {
          const ultimaFacturaElement = document.getElementById('ultimaFactura');
          const ultimaFacturaInfoElement = document.getElementById('ultimaFacturaInfo');
          const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');

          if (ultimaFacturaElement && ultimaFacturaInfoElement && ultimaFacturaTimeElement) {
            // Actualizar monto
            ultimaFacturaElement.textContent = formatearMoneda(parseFloat(factura.monto));

            // Actualizar información
            ultimaFacturaInfoElement.textContent = `#${factura.numero} - ${
              factura.encargado
            } - ${factura.metodoPago.toUpperCase()}`;

            // Actualizar tiempo
            const fechaFactura = new Date(factura.fecha);
            const horaColombia = fechaFactura.toLocaleTimeString('es-CO', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true,
              timeZone: 'America/Bogota',
            });
            ultimaFacturaTimeElement.textContent = `Registrada a las ${horaColombia}`;

            console.log('✅ Última factura actualizada inmediatamente:', factura.numero);
          }
        } catch (error) {
          console.error('❌ Error actualizando última factura:', error);
        }
      }

      // Cargar configuración
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        cambiarMoneda(moneda);
      }

      // Función para manejar cambio en encargado
      function manejarCambioEncargado() {
        const encargadoSelect = document.getElementById('encargado');
        const encargadoOtro = document.getElementById('encargadoOtro');

        if (encargadoSelect.value === 'otro') {
          encargadoOtro.style.display = 'block';
          encargadoOtro.required = true;
        } else {
          encargadoOtro.style.display = 'none';
          encargadoOtro.required = false;
          encargadoOtro.value = '';
        }
      }

      // Función para obtener el nombre del encargado
      function obtenerNombreEncargado() {
        const encargadoSelect = document.getElementById('encargado');
        const encargadoOtro = document.getElementById('encargadoOtro');

        if (encargadoSelect.value === 'otro') {
          return encargadoOtro.value;
        }
        return encargadoSelect.value;
      }

      // Función para exportar a Excel usando plantilla existente
      async function exportarFacturasExcel() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

          if (facturas.length === 0) {
            mostrarMensaje('No hay facturas para exportar', 'warning');
            return;
          }

          // Crear libro de Excel usando la plantilla
          const workbook = XLSX.utils.book_new();

          // Crear hoja de trabajo con los datos
          const datosExcel = [
            ['CUADRE DE CAJA - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACIÓN: ${new Date().toLocaleDateString()}`],
            [''], // Línea en blanco
            ['ID', 'Empleado', 'Cédula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          let totalValor = 0;

          facturas.forEach((factura) => {
            const valor = parseFloat(factura.monto || 0);
            totalValor += valor;

            datosExcel.push([
              factura.numero || 'N/A',
              factura.encargado || 'N/A',
              factura.cedulaEncargado || 'N/A',
              factura.fecha || 'N/A',
              factura.descripcion || 'N/A',
              valor,
              factura.estado || 'N/A',
              factura.linkFactura || 'N/A',
            ]);
          });

          // Agregar línea en blanco y totales
          datosExcel.push(['']);
          datosExcel.push(['TOTALES', '', '', '', '', totalValor, '', '']);

          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 15 }, // ID
            { width: 25 }, // Empleado
            { width: 15 }, // Cédula
            { width: 15 }, // Fecha
            { width: 30 }, // Concepto
            { width: 15 }, // Valor
            { width: 15 }, // Estado
            { width: 40 }, // Observaciones
          ];

          // Aplicar estilos a las celdas
          const range = XLSX.utils.decode_range(worksheet['!ref']);

          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cellAddress]) continue;

              // Estilo para título principal (primera fila)
              if (R === 0) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: '4F81BD' } }, // Azul profesional
                  font: {
                    color: { rgb: 'FFFFFF' },
                    bold: true,
                    sz: 16,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para información de empresa (filas 1-3)
              else if (R >= 1 && R <= 3) {
                worksheet[cellAddress].s = {
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'left',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para encabezados de tabla (fila 5)
              else if (R === 5) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'D9E1F2' } }, // Azul claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 11,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: '000000' } },
                    bottom: { style: 'thin', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para fila de totales (última fila)
              else if (R === range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'C6EFCE' } }, // Verde claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'medium', color: { rgb: '000000' } },
                    bottom: { style: 'medium', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para datos (filas intermedias)
              else if (R > 5 && R < range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: R % 2 === 0 ? 'FFFFFF' : 'F8F9FA' } }, // Filas alternadas
                  font: {
                    color: { rgb: '000000' },
                    sz: 10,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    bottom: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    left: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    right: { style: 'thin', color: { rgb: 'D0D0D0' } },
                  },
                };

                // Formato especial para columna de valor
                if (C === 5) {
                  // Columna de valor
                  worksheet[cellAddress].s.numberFormat = '"$"#,##0.00';
                }
              }
            }
          }

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Cuadre de Caja');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `CUADRE_CAJA_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);

          console.log('✅ Facturas exportadas correctamente:', nombreArchivo);
          mostrarMensaje('✅ Facturas exportadas a Excel con formato profesional', 'success');
        } catch (error) {
          console.error('❌ Error exportando facturas:', error);
          mostrarMensaje('Error al exportar: ' + error.message, 'error');
        }
      }

      // Función para registrar factura
      document.getElementById('formFactura').addEventListener('submit', function (e) {
        e.preventDefault();

        // Obtener usuario actual
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        const factura = {
          id: Date.now().toString(),
          fecha: document.getElementById('fecha').value,
          encargado: obtenerNombreEncargado(),
          cedulaEncargado: document.getElementById('cedulaEncargado').value,
          numero: document.getElementById('numeroFactura').value,
          area: document.getElementById('area').value,
          monto: document.getElementById('monto').value,
          metodoPago: document.getElementById('metodoPago').value,
          descripcion: document.getElementById('descripcion').value,
          estado: document.getElementById('estado').value,
          linkFactura: document.getElementById('linkFactura').value,
          userId: currentUser ? currentUser.username || currentUser.email : 'admin',
          createdAt: new Date().toISOString(),
        };

        facturas.unshift(factura);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        limpiarFormulario();

        mostrarMensaje('✅ Factura registrada correctamente', 'success');

        // Actualizar inmediatamente la última factura
        actualizarUltimaFactura(factura);

        // Actualizar resumen del día en tiempo real
        setTimeout(() => {
          cargarResumen();
        }, 100);
      });

      // Limpiar formulario
      function limpiarFormulario() {
        document.getElementById('formFactura').reset();
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('encargadoOtro').style.display = 'none'; // Ocultar el input de texto
        document.getElementById('cedulaEncargado').value = ''; // Limpiar cédula
      }

      // Eliminar factura
      function eliminarFactura(id) {
        // Obtener información de la factura
        const factura = facturas.find((f) => f.id === id);
        if (!factura) {
          mostrarMensaje('❌ Factura no encontrada', 'error');
          return;
        }

        // Mostrar modal de confirmación
        mostrarModalEliminarFactura(factura);
      }

      // Función para aplicar filtros de facturas
      function aplicarFiltrosFacturas() {
        try {
          const fechaDesde = document.getElementById('filterFechaDesde').value;
          const fechaHasta = document.getElementById('filterFechaHasta').value;
          const filtroRapido = document.getElementById('filterFechaFacturas').value;
          const filtroArea = document.getElementById('filterAreaFacturas').value;
          const filtroMetodo = document.getElementById('filterMetodoPago').value;
          const busqueda = document.getElementById('searchFacturas').value.toLowerCase();

          // Obtener todas las facturas
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          let facturasFiltradas = [...facturas];

          // Aplicar filtro de fechas
          if (fechaDesde || fechaHasta || filtroRapido) {
            facturasFiltradas = facturasFiltradas.filter((factura) => {
              const fechaFactura = new Date(factura.fecha);

              // Filtros rápidos
              if (filtroRapido) {
                const hoy = new Date();
                const inicioDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

                switch (filtroRapido) {
                  case 'hoy':
                    return fechaFactura >= inicioDia;
                  case 'ayer':
                    const ayer = new Date(inicioDia);
                    ayer.setDate(ayer.getDate() - 1);
                    return fechaFactura >= ayer && fechaFactura < inicioDia;
                  case 'semana':
                    const inicioSemana = new Date(inicioDia);
                    inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
                    return fechaFactura >= inicioSemana;
                  case 'mes':
                    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    return fechaFactura >= inicioMes;
                  case 'mesAnterior':
                    const inicioMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    const finMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    return fechaFactura >= inicioMesAnterior && fechaFactura <= finMesAnterior;
                  case 'trimestre':
                    const trimestre = Math.floor(hoy.getMonth() / 3);
                    const inicioTrimestre = new Date(hoy.getFullYear(), trimestre * 3, 1);
                    return fechaFactura >= inicioTrimestre;
                  case 'año':
                    const inicioAño = new Date(hoy.getFullYear(), 0, 1);
                    return fechaFactura >= inicioAño;
                }
              }

              // Filtros de fecha específica
              if (fechaDesde && fechaFactura < new Date(fechaDesde)) {
                return false;
              }
              if (fechaHasta) {
                const fechaHastaObj = new Date(fechaHasta);
                fechaHastaObj.setHours(23, 59, 59, 999);
                if (fechaFactura > fechaHastaObj) {
                  return false;
                }
              }

              return true;
            });
          }

          // Aplicar filtro de área
          if (filtroArea) {
            facturasFiltradas = facturasFiltradas.filter((factura) => factura.area === filtroArea);
          }

          // Aplicar filtro de método de pago
          if (filtroMetodo) {
            facturasFiltradas = facturasFiltradas.filter((factura) => factura.metodoPago === filtroMetodo);
          }

          // Aplicar búsqueda por texto
          if (busqueda) {
            facturasFiltradas = facturasFiltradas.filter(
              (factura) =>
                factura.numero.toLowerCase().includes(busqueda) ||
                factura.encargado.toLowerCase().includes(busqueda) ||
                factura.descripcion.toLowerCase().includes(busqueda)
            );
          }

          // Mostrar facturas filtradas
          mostrarFacturasFiltradas(facturasFiltradas);

          // Mostrar resumen de filtros aplicados
          const totalFiltradas = facturasFiltradas.length;
          const totalOriginal = facturas.length;
          mostrarMensaje(`✅ Filtros aplicados: ${totalFiltradas} de ${totalOriginal} facturas`, 'success');
        } catch (error) {
          console.error('❌ Error aplicando filtros:', error);
          mostrarMensaje('❌ Error al aplicar filtros: ' + error.message, 'error');
        }
      }

      // Función para mostrar facturas filtradas
      function mostrarFacturasFiltradas(facturasFiltradas) {
        const tbody = document.getElementById('facturasTableBody');
        if (!tbody) return;

        if (facturasFiltradas.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="axyra-text-center">
                <div class="axyra-empty-state">
                  <i class="fas fa-search" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                  <p>No se encontraron facturas con los filtros aplicados</p>
                  <button class="axyra-btn axyra-btn-primary" onclick="limpiarFiltrosFacturas()">
                    Limpiar Filtros
                  </button>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        // Mostrar facturas filtradas
        mostrarFacturas(facturasFiltradas);
      }

      // Función para limpiar filtros
      function limpiarFiltrosFacturas() {
        document.getElementById('filterFechaDesde').value = '';
        document.getElementById('filterFechaHasta').value = '';
        document.getElementById('filterFechaFacturas').value = '';
        document.getElementById('filterAreaFacturas').value = '';
        document.getElementById('filterMetodoPago').value = '';
        document.getElementById('searchFacturas').value = '';

        // Recargar todas las facturas
        mostrarFacturas();
        mostrarMensaje('✅ Filtros limpiados', 'success');
      }

      // Función para mostrar modal de eliminación
      function mostrarModalEliminarFactura(factura) {
        const modalHTML = `
          <div id="modalEliminarFactura" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Confirmar Eliminación
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-confirmacion-container">
                  <div class="axyra-confirmacion-icon">
                    <i class="fas fa-trash-alt" style="color: #ef4444; font-size: 48px;"></i>
                  </div>
                  <div class="axyra-confirmacion-texto">
                    <h4>¿Estás seguro de que deseas eliminar esta factura?</h4>
                    <p>Esta acción no se puede deshacer.</p>
                  </div>
                  <div class="axyra-factura-info">
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Número:</span>
                      <span class="axyra-factura-value">${factura.numero}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Encargado:</span>
                      <span class="axyra-factura-value">${factura.encargado}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Área:</span>
                      <span class="axyra-factura-value">${factura.area}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Monto:</span>
                      <span class="axyra-factura-value">$${factura.monto.toLocaleString('es-CO')}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Fecha:</span>
                      <span class="axyra-factura-value">${new Date(factura.fecha).toLocaleDateString('es-CO')}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="axyra-btn axyra-btn-danger" onclick="confirmarEliminarFactura('${
                  factura.id
                }')">
                  <i class="fas fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Función para cerrar modal de eliminación
      function cerrarModalEliminarFactura() {
        const modal = document.getElementById('modalEliminarFactura');
        if (modal) {
          modal.remove();
        }
      }

      // Función para confirmar eliminación
      function confirmarEliminarFactura(id) {
        // Cerrar modal
        cerrarModalEliminarFactura();

        // Eliminar factura
        facturas = facturas.filter((f) => f.id !== id);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje('✅ Factura eliminada correctamente', 'success');
      }

      // Exportar facturas a Excel profesional
      function exportarFacturas() {
        if (facturas.length === 0) {
          mostrarMensaje('❌ No hay facturas para exportar', 'warning');
          return;
        }

        try {
          // Verificar si XLSX está disponible
          if (typeof XLSX === 'undefined') {
            mostrarMensaje('Error: Librería XLSX no está disponible', 'error');
            return;
          }

          console.log('📊 Iniciando exportación de facturas...');
          console.log('📋 Total de facturas a exportar:', facturas.length);

          // Crear datos para exportar
          const data = [
            ['REPORTE DE FACTURAS - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACIÓN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
            [],
            ['ID', 'Empleado', 'Cédula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          // Agregar datos de cada factura
          facturas.forEach((f, index) => {
            const empleado = empleados.find((e) => e.id === f.empleado_id);
            console.log(`📝 Procesando factura ${index + 1}:`, f.id, empleado?.nombre);

            data.push([
              f.id || 'N/A',
              empleado ? empleado.nombre : 'Empleado no encontrado',
              empleado ? empleado.cedula || 'N/A' : 'N/A',
              new Date(f.fecha).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' }),
              f.concepto || 'N/A',
              formatearMoneda(f.valor),
              f.estado || 'Activa',
              f.observaciones || 'N/A',
            ]);
          });

          // Agregar totales
          data.push([]);
          const totales = [
            'TOTALES',
            '',
            '',
            '',
            formatearMoneda(facturas.reduce((sum, f) => sum + (f.valor || 0), 0)),
            '',
            '',
          ];
          data.push(totales);

          console.log('📊 Datos preparados para exportación');

          // Crear hoja de trabajo
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Facturas');

          // Ajustar ancho de columnas
          ws['!cols'] = [
            { width: 8 },
            { width: 25 },
            { width: 15 },
            { width: 15 },
            { width: 30 },
            { width: 18 },
            { width: 12 },
            { width: 30 },
          ];

          // Generar nombre de archivo
          const now = new Date();
          const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
          const fileName = `REPORTE_FACTURAS_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime
            .getHours()
            .toString()
            .padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;

          console.log('💾 Descargando archivo:', fileName);

          // Descargar archivo
          XLSX.writeFile(wb, fileName);

          console.log('✅ Exportación completada exitosamente');
          mostrarMensaje('Facturas exportadas correctamente con formato profesional', 'success');
        } catch (error) {
          console.error('❌ Error exportando facturas:', error);
          mostrarMensaje(`❌ Error al exportar: ${error.message}`, 'error');
        }
      }

      // Función para exportar cuadre de caja
      function exportarCuadreCaja() {
        try {
          if (facturas.length === 0) {
            mostrarMensaje('❌ No hay facturas para exportar', 'error');
            return;
          }

          // Verificar si XLSX está disponible
          if (typeof XLSX === 'undefined') {
            mostrarMensaje('Error: Librería XLSX no está disponible', 'error');
            return;
          }

          console.log('📊 Iniciando exportación de cuadre de caja...');
          console.log('📋 Total de facturas a exportar:', facturas.length);

          // Crear datos para exportar
          const data = [
            ['CUADRE DE CAJA - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACIÓN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
            [],
            ['ID', 'Empleado', 'Cédula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          // Agregar datos de cada factura
          facturas.forEach((f, index) => {
            const empleado = empleados.find((e) => e.id === f.empleado_id);
            console.log(`📝 Procesando factura ${index + 1}:`, f.id, empleado?.nombre);

            data.push([
              f.id || 'N/A',
              empleado ? empleado.nombre : 'Empleado no encontrado',
              empleado ? empleado.cedula || 'N/A' : 'N/A',
              new Date(f.fecha).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' }),
              f.concepto || 'N/A',
              formatearMoneda(f.valor),
              f.estado || 'Activa',
              f.observaciones || 'N/A',
            ]);
          });

          // Agregar totales
          data.push([]);
          const totales = [
            'TOTALES',
            '',
            '',
            '',
            formatearMoneda(facturas.reduce((sum, f) => sum + (f.valor || 0), 0)),
            '',
            '',
          ];
          data.push(totales);

          console.log('📊 Datos preparados para exportación');

          // Crear hoja de trabajo
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Cuadre de Caja');

          // Ajustar ancho de columnas
          ws['!cols'] = [
            { width: 8 },
            { width: 25 },
            { width: 15 },
            { width: 15 },
            { width: 30 },
            { width: 18 },
            { width: 12 },
            { width: 30 },
          ];

          // Generar nombre de archivo
          const now = new Date();
          const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
          const fileName = `CUADRE_CAJA_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime
            .getHours()
            .toString()
            .padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;

          console.log('💾 Descargando archivo:', fileName);

          // Descargar archivo
          XLSX.writeFile(wb, fileName);

          console.log('✅ Exportación completada exitosamente');
          mostrarMensaje('Cuadre de caja exportado correctamente con formato profesional', 'success');
        } catch (error) {
          console.error('❌ Error exportando cuadre de caja:', error);
          mostrarMensaje(`❌ Error al exportar: ${error.message}`, 'error');
        }
      }

      // Limpiar historial
      function limpiarHistorial() {
        if (confirm('¿Estás seguro de que deseas limpiar todo el historial? Esta acción no se puede deshacer.')) {
          facturas = [];
          localStorage.removeItem('axyra_facturas');

          mostrarFacturas();
          cargarResumen();

          mostrarMensaje('✅ Historial limpiado correctamente', 'success');
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }
    </script>

    <style>
      .axyra-currency-info {
        text-align: center;
        padding: var(--spacing-lg);
      }

      .axyra-currency-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        font-size: 1.1rem;
      }

      .axyra-currency-flag {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .axyra-currency-description {
        color: var(--axyra-gray-600);
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
      }

      /* Estilos para el modal de eliminación */
      .axyra-confirmacion-container {
        text-align: center;
        padding: 20px;
      }

      .axyra-confirmacion-icon {
        margin-bottom: 20px;
      }

      .axyra-confirmacion-texto h4 {
        color: #1f2937;
        margin-bottom: 10px;
        font-size: 18px;
      }

      .axyra-confirmacion-texto p {
        color: #6b7280;
        margin-bottom: 25px;
      }

      .axyra-factura-info {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e2e8f0;
      }

      .axyra-factura-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .axyra-factura-item:last-child {
        border-bottom: none;
      }

      .axyra-factura-label {
        font-weight: 600;
        color: #374151;
      }

      .axyra-factura-value {
        font-weight: 500;
        color: #1f2937;
      }

      /* Botón de peligro */
      .axyra-btn-danger {
        background: #ef4444;
        color: white;
        border: none;
      }

      .axyra-btn-danger:hover {
        background: #dc2626;
      }

      /* Estilos para última factura */
      .axyra-ultima-factura-container {
        text-align: center;
        padding: 30px;
      }

      .axyra-ultima-factura-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .axyra-ultima-factura-monto {
        font-size: 2.5rem;
        font-weight: 700;
        color: #10b981;
        text-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }

      .axyra-ultima-factura-details {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
        max-width: 400px;
        line-height: 1.4;
      }

      .axyra-ultima-factura-time {
        font-size: 0.9rem;
        color: #6b7280;
        font-style: italic;
      }

      /* Estilos para filtros de fecha */
      .axyra-date-filters {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .axyra-date-filters input[type='date'] {
        min-width: 140px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .axyra-date-filters input[type='date']:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Estado vacío para tabla */
      .axyra-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .axyra-empty-state i {
        display: block;
        margin-bottom: 1rem;
      }

      .axyra-empty-state p {
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
      }

      /* Responsive para resumen */
      @media (max-width: 1200px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .axyra-ultima-factura-monto {
          font-size: 2rem;
        }
      }
    </style>

    <!-- Inicialización automática del módulo de cuadre de caja -->
    <script>
      // Inicializar módulo de cuadre de caja cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Módulo de cuadre de caja cargado, verificando autenticación...');

        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await inicializarCuadreCaja();
        }, 500);
      });

      // Función para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('🔄 Cargando datos desde Firebase...');

          // Verificar si Firebase está disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('⚠️ Firebase no disponible, usando localStorage como fallback');
            await cargarDatosLocalStorage();
            return;
          }

          const db = firebase.firestore();

          // Obtener userId del usuario autenticado en Firebase
          let userId = null;

          // Intentar obtener el usuario actual de Firebase Auth
          if (firebase.auth().currentUser) {
            userId = firebase.auth().currentUser.uid;
            console.log('✅ Usuario autenticado en Firebase:', userId);
          } else {
            // Fallback: buscar en localStorage o usar el usuario aislado
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              const user = JSON.parse(userData);
              userId = user.username || user.email;
            }

            if (!userId) {
              console.warn('⚠️ No se puede identificar usuario, usando localStorage');
              await cargarDatosLocalStorage();
              return;
            }
          }

          console.log('🔍 Buscando datos para userId:', userId);

          // Cargar empleados desde Firebase - buscar por userId
          try {
            const empleadosSnapshot = await db.collection('empleados').where('userId', '==', userId).get();

            empleados = empleadosSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${empleados.length} empleados cargados desde Firebase para userId: ${userId}`);

            // Si no hay empleados con ese userId, intentar buscar sin filtro
            if (empleados.length === 0) {
              console.log('🔍 No se encontraron empleados con userId específico, buscando todos...');
              const allEmpleadosSnapshot = await db.collection('empleados').get();
              empleados = allEmpleadosSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              console.log(`✅ ${empleados.length} empleados totales encontrados en Firebase`);
            }
          } catch (error) {
            console.warn('⚠️ Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar facturas desde Firebase
          try {
            const facturasSnapshot = await db.collection('facturas').where('userId', '==', userId).get();

            facturas = facturasSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${facturas.length} facturas cargadas desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando facturas desde Firebase:', error);
            facturas = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_facturas', JSON.stringify(facturas));
        } catch (error) {
          console.error('❌ Error cargando datos desde Firebase:', error);
          // Fallback a localStorage
          await cargarDatosLocalStorage();
        }
      }

      // Función para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('🔄 Cargando datos desde localStorage...');

          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username;
            });
          }

          // Cargar facturas
          const facturasData = localStorage.getItem('axyra_facturas');
          if (facturasData) {
            facturas = JSON.parse(facturasData);
            // Filtrar por usuario actual
            facturas = facturas.filter((f) => {
              if (!f.userId) return true; // Datos globales
              return f.userId === currentUser?.username;
            });
          }

          console.log(
            `✅ Datos cargados desde localStorage: ${empleados.length} empleados, ${facturas.length} facturas`
          );
        } catch (error) {
          console.error('❌ Error cargando datos desde localStorage:', error);
        }
      }

      // Función de inicialización mejorada
      async function inicializarCuadreCaja() {
        try {
          console.log('🚀 Inicializando módulo de cuadre de caja...');

          // Verificar autenticación
          await verificarAutenticacion();

          // Intentar cargar desde Firebase primero
          await cargarDatosFirebase();

          // Los selects no son necesarios en este módulo

          // Renderizar tabla
          renderizarTablaFacturas();

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();

          console.log('✅ Módulo de cuadre de caja inicializado correctamente');
        } catch (error) {
          console.error('❌ Error inicializando cuadre de caja:', error);
          mostrarNotificacion('Error inicializando módulo de cuadre de caja', 'error');
        }
      }
    </script>
  </body>
</html>
